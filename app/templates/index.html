<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ACBUDDY Lab</title>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        "primary": "#0dccf2",
        "primary-glow": "rgba(13,204,242,0.4)",
        "bg": "#f5f8f8",
        "chrome": "#e2e8e8",
      },
      fontFamily: { display: ["Inter","sans-serif"] },
      borderRadius: { DEFAULT:"1rem", lg:"2rem", xl:"3rem", full:"9999px" },
      boxShadow: {
        glass: "0 8px 32px 0 rgba(31,38,135,0.07)",
        glow: "0 0 20px rgba(13,204,242,0.5), 0 0 60px rgba(13,204,242,0.2)",
        "inner-chrome": "inset 0 2px 4px 0 rgba(255,255,255,0.9), inset 0 -2px 4px 0 rgba(0,0,0,0.1)",
        neumorphic: "20px 20px 60px #d1d9d9, -20px -20px 60px #ffffff",
      },
      backgroundImage: {
        "chrome-gradient": "linear-gradient(135deg, #ffffff 0%, #f0f4f4 50%, #dce3e3 100%)",
      },
    },
  },
}
</script>
<style>
  body { min-height: 100dvh; background: #f5f8f8; }
  .glass-panel {
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.8);
  }
  .view { display:none; flex-direction:column; }
  .view.active { display:flex; }
  @keyframes shimmer { 0%{transform:translateX(-100%)} 100%{transform:translateX(300%)} }
  @keyframes spin { to{transform:rotate(360deg)} }
  @keyframes pulse-bar { 0%,100%{transform:scaleY(0.5)} 50%{transform:scaleY(1)} }

  /* Agent card — neumorphic glass style */
  .agent-cyan { --ac: #0dccf2; }
  .agent-amber { --ac: #f59e0b; }
  .agent-violet { --ac: #8b5cf6; }
  .agent-card {
    background: rgba(255,255,255,0.5);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.7);
    border-radius: 1.25rem;
    padding: 1.25rem;
    cursor: pointer;
    transition: all 0.25s;
    box-shadow: 6px 6px 16px #d1d9d9, -6px -6px 16px #ffffff;
  }
  .agent-card:hover { transform: translateY(-3px); box-shadow: 8px 8px 20px #c8d0d0, -8px -8px 20px #ffffff; }
  .agent-card:active { transform: scale(0.98); }
  .agent-card .agent-icon { color: var(--ac); }
  .agent-card .agent-accent { color: var(--ac); }
  .agent-card .agent-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--ac); box-shadow: 0 0 8px var(--ac); }
  .agent-card .kb-tag {
    display: inline-block; font-size: 10px; padding: 2px 8px; border-radius: 6px;
    background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05);
    color: #64748b; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }

  /* Widget overlay */
  .widget-overlay {
    position: fixed; inset:0; z-index:200;
    background: rgba(245,248,248,0.92);
    backdrop-filter: blur(12px);
    display: none; flex-direction: column; align-items: center; justify-content: center;
  }
  .widget-overlay.active { display: flex; }

  /* Call overlay pulse */
  @keyframes call-ring { 0%{transform:scale(1);opacity:0.4} 100%{transform:scale(1.3);opacity:0} }
  #call-pulse-ring:not(.hidden) { animation: call-ring 2s ease-out infinite; }
</style>
</head>
<body class="font-display text-slate-600 flex flex-col items-center overflow-x-hidden">

<!-- Background blurs -->
<div class="fixed inset-0 pointer-events-none overflow-hidden">
  <div class="absolute top-[-20%] left-[-10%] w-[500px] h-[500px] bg-primary/5 rounded-full blur-[100px]"></div>
  <div class="absolute bottom-[-10%] right-[-10%] w-[400px] h-[400px] bg-primary/10 rounded-full blur-[80px]"></div>
  <div class="absolute inset-0 opacity-[0.03]" style="background-image:radial-gradient(#0dccf2 1px,transparent 1px);background-size:40px 40px"></div>
</div>

<main class="relative z-10 w-full max-w-md min-h-screen flex flex-col px-6 sm:px-8 pb-28">

  <!-- ════════════ HOME VIEW ════════════ -->
  <div id="view-home" class="view active flex-1">
    <!-- Header -->
    <header class="flex flex-col items-center mt-6 space-y-2 opacity-80">
      <div class="flex items-center space-x-2 text-[10px] tracking-[0.2em] font-medium uppercase text-slate-400">
        <span class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></span>
        <span>System Online</span>
      </div>
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
      <div class="flex items-center space-x-12 mt-4">
        <div class="flex flex-col items-center">
          <span class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">Researching</span>
          <div class="flex items-center space-x-1">
            <span class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></span>
            <span id="stat-researching" class="text-lg font-medium text-slate-700">00</span>
          </div>
        </div>
        <div class="w-px h-8 bg-gradient-to-b from-transparent via-slate-200 to-transparent"></div>
        <div class="flex flex-col items-center">
          <span class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">Completed</span>
          <div class="flex items-center space-x-1">
            <span class="material-icons text-[10px] text-primary">check_circle</span>
            <span id="stat-completed" class="text-lg font-medium text-slate-700">0</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Active research banner (shown when job is running) -->
    <div id="active-research-banner" class="hidden mt-4 cursor-pointer" onclick="App.resumeProgress()">
      <div class="glass-panel rounded-xl p-3 shadow-glass border border-primary/20 flex items-center gap-3">
        <div class="relative w-8 h-8 flex-shrink-0">
          <div class="absolute inset-0 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 1.2s linear infinite"></div>
        </div>
        <div class="flex-1 min-w-0">
          <div class="text-xs font-semibold text-slate-700 truncate" id="banner-query"></div>
          <div class="text-[10px] text-slate-400"><span id="banner-phase">Running...</span> &middot; <span id="banner-countdown" class="text-primary font-mono">--:--</span> remaining</div>
        </div>
        <span class="material-icons text-primary text-lg">arrow_forward</span>
      </div>
    </div>

    <!-- Input + Button -->
    <div class="flex-1 flex flex-col items-center justify-center w-full space-y-10 -mt-4">
      <!-- Glass input panel -->
      <div class="w-full relative group transform transition-all duration-300 hover:scale-[1.01]">
        <div class="absolute -inset-1 bg-gradient-to-r from-primary/20 to-slate-200/30 rounded-[2rem] blur-md opacity-50 group-hover:opacity-100 transition duration-500"></div>
        <div class="glass-panel relative rounded-[2rem] flex flex-col items-start px-7 py-5 shadow-glass border border-white/60">
          <div class="flex items-center w-full mb-2">
            <span class="material-icons text-primary/80 mr-3 text-xl">mic_none</span>
            <span class="text-[10px] uppercase tracking-widest text-primary/60 font-semibold">Voice Input Active</span>
          </div>
          <input id="query-input" type="text" class="bg-transparent border-none w-full text-slate-800 placeholder-slate-400 focus:ring-0 text-lg tracking-wide font-light p-0 h-10" placeholder="Awaiting Command...">
          <div class="w-full h-0.5 bg-slate-100 mt-3 relative overflow-hidden rounded-full">
            <div class="absolute top-0 left-0 h-full w-1/3 bg-primary/50" style="animation:shimmer 2s infinite"></div>
          </div>
          <!-- Depth pills -->
          <div id="depth-selector" class="flex gap-2 mt-4 w-full">
            <button class="depth-btn flex-1 py-2 rounded-xl text-xs font-medium tracking-wide border border-slate-200 text-slate-400 transition-all hover:border-primary/30" data-depth="QUICK">Quick</button>
            <button class="depth-btn flex-1 py-2 rounded-xl text-xs font-medium tracking-wide border border-primary text-primary bg-primary/10 transition-all" data-depth="STANDARD">Standard</button>
            <button class="depth-btn flex-1 py-2 rounded-xl text-xs font-medium tracking-wide border border-slate-200 text-slate-400 transition-all hover:border-primary/30" data-depth="DEEP">Deep</button>
          </div>
        </div>
      </div>

      <!-- Neumorphic ACTIVATE button -->
      <div class="relative flex items-center justify-center">
        <div class="w-56 h-56 rounded-full bg-chrome-gradient shadow-neumorphic flex items-center justify-center relative">
          <div class="absolute inset-0 rounded-full border border-slate-200/50"></div>
          <div class="absolute inset-2 rounded-full border border-slate-100"></div>
          <button id="activate-btn" class="w-40 h-40 rounded-full bg-white shadow-inner-chrome flex items-center justify-center relative group active:scale-95 transition-transform duration-200 overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-tr from-slate-50 to-slate-100 z-0"></div>
            <div class="absolute w-full h-full opacity-0 group-hover:opacity-100 transition-opacity duration-700 bg-primary/5 blur-xl"></div>
            <div class="relative z-10 flex flex-col items-center justify-center">
              <div class="w-20 h-20 rounded-full bg-gradient-to-br from-primary to-cyan-300 shadow-glow flex items-center justify-center mb-2 group-hover:scale-105 transition-transform duration-300">
                <span class="material-icons text-white text-4xl drop-shadow-md">fingerprint</span>
              </div>
              <span class="text-[10px] font-semibold tracking-[0.25em] text-slate-400 group-hover:text-primary transition-colors duration-300 mt-2">ACTIVATE</span>
            </div>
            <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/40 to-transparent pointer-events-none rounded-t-full"></div>
          </button>
          <div class="absolute inset-0 pointer-events-none" style="animation:spin 8s linear infinite">
            <div class="absolute top-5 left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-primary/60 blur-[1px]"></div>
          </div>
        </div>
      </div>

      <!-- Agent KB status bar -->
      <div class="flex justify-between w-full px-6 text-[10px] text-slate-400 font-mono opacity-60">
        <span>MAYA: <span id="kb-maya" class="text-primary/80">--</span></span>
        <span>BARN: <span id="kb-barnaby" class="text-amber-400/80">--</span></span>
        <span>CONS: <span id="kb-consultant" class="text-violet-400/80">--</span></span>
      </div>
    </div>
  </div>

  <!-- ════════════ VALIDATION VIEW (DEEP only) ════════════ -->
  <div id="view-validate" class="view flex-1">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
      <p class="text-xs text-primary">Query Review</p>
    </header>
    <div class="flex-1 flex flex-col items-center justify-center gap-5 px-2">
      <div class="w-16 h-16 rounded-full bg-amber-50 flex items-center justify-center">
        <span class="material-icons text-amber-400 text-3xl">rate_review</span>
      </div>
      <div class="text-base font-semibold text-slate-700 text-center">Let's sharpen this query</div>
      <div id="validate-feedback" class="text-sm text-slate-500 text-center leading-relaxed px-2"></div>
      <div id="validate-suggested" class="glass-panel rounded-xl p-4 w-full shadow-glass border border-white/60 hidden">
        <div class="text-[10px] uppercase tracking-widest text-primary/60 font-semibold mb-2">Suggested query</div>
        <div id="validate-suggested-text" class="text-sm text-slate-700 font-medium"></div>
      </div>
      <button id="validate-use-suggested" onclick="App.useSuggested()"
              class="w-full py-3 rounded-xl bg-primary text-white text-center font-semibold text-sm hidden">
        Use Suggested Query
      </button>
      <button onclick="App.forceStart()"
              class="w-full py-3 rounded-xl border border-slate-200 text-slate-500 text-center font-medium text-sm hover:bg-slate-50">
        Start Anyway With Original
      </button>
      <button onclick="App.showView('home')"
              class="text-xs text-slate-400 hover:text-primary transition-colors">
        Back to edit
      </button>
    </div>
  </div>

  <!-- ════════════ PROGRESS VIEW ════════════ -->
  <div id="view-progress" class="view flex-1" style="overflow-y:auto">
    <header class="flex flex-col items-center mt-4 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
      <p class="text-xs text-primary">Researching...</p>
    </header>
    <div class="flex flex-col items-center gap-4 px-2 pb-4">
      <!-- Compact spinner + phase -->
      <div class="flex items-center gap-3 mt-3">
        <div class="relative w-10 h-10 flex-shrink-0">
          <div class="absolute inset-0 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 1.2s linear infinite"></div>
          <div class="absolute inset-1.5 border-2 border-slate-200 border-t-primary/50 rounded-full" style="animation:spin 1.8s linear infinite reverse"></div>
          <div class="absolute inset-0 flex items-center justify-center">
            <span class="material-icons text-primary text-sm">search</span>
          </div>
        </div>
        <div id="phase-text" class="text-sm text-slate-600 font-medium">Starting...</div>
      </div>

      <!-- Countdown + elapsed -->
      <div class="flex items-center gap-6 text-center">
        <div>
          <div class="text-[10px] uppercase tracking-wider text-slate-400 mb-0.5">Elapsed</div>
          <div id="elapsed" class="text-base font-mono font-medium text-slate-600 tabular-nums">0:00</div>
        </div>
        <div class="w-px h-6 bg-gradient-to-b from-transparent via-slate-200 to-transparent"></div>
        <div>
          <div class="text-[10px] uppercase tracking-wider text-slate-400 mb-0.5">Est. Remaining</div>
          <div id="countdown" class="text-base font-mono font-medium text-primary tabular-nums">--:--</div>
        </div>
      </div>

      <!-- Progress bar -->
      <div class="w-full px-2">
        <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
          <div id="progress-bar" class="h-full bg-gradient-to-r from-primary to-cyan-300 rounded-full transition-all duration-1000" style="width:0%"></div>
        </div>
        <div class="flex justify-between mt-0.5">
          <span id="progress-start" class="text-[10px] text-slate-400 font-mono">--:--</span>
          <span id="progress-pct" class="text-[10px] text-primary font-semibold">0%</span>
          <span id="progress-eta" class="text-[10px] text-slate-400 font-mono">--:--</span>
        </div>
      </div>

      <!-- Study plan tracker (DEEP only, populated by poll()) -->
      <div id="study-tracker" class="w-full space-y-1.5 hidden">
        <div class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold px-1">Research Plan</div>
        <div id="study-list" class="space-y-1"></div>
      </div>

      <!-- Pipeline steps tracker -->
      <div id="pipeline-steps" class="w-full hidden">
        <div class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold px-1 mb-1">Pipeline</div>
        <div id="step-list" class="space-y-1"></div>
      </div>

      <!-- Mid-research status card -->
      <div id="mid-check" class="glass-panel rounded-xl p-2.5 w-full shadow-glass border border-white/60">
        <div class="flex items-center gap-2">
          <span id="mid-check-icon" class="w-2 h-2 rounded-full bg-primary animate-pulse"></span>
          <span id="mid-check-text" class="text-[11px] text-slate-500">Pipeline running normally</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ════════════ RESULT VIEW ════════════ -->
  <div id="view-result" class="view flex-1">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
    </header>
    <div class="flex-1 flex flex-col items-center justify-center gap-4 px-2">
      <span class="material-icons text-6xl text-emerald-400">check_circle</span>
      <div class="text-lg font-semibold text-slate-700">Research Complete</div>
      <div id="result-query" class="text-sm text-slate-400 text-center"></div>
      <div class="w-full flex gap-2">
        <a id="result-link" href="#" target="_blank" rel="noopener"
           class="flex-1 py-3 rounded-xl bg-primary text-white text-center font-semibold text-sm tracking-wide hover:opacity-85 transition-opacity block">
          View Full Report
        </a>
        <button id="copy-url-btn" onclick="App.copyReportUrl()"
                class="px-4 py-3 rounded-xl border border-slate-200 text-slate-500 hover:bg-slate-50 hover:text-primary transition-colors flex items-center gap-1.5"
                title="Copy report URL (e.g. for NotebookLM)">
          <span class="material-icons text-lg">content_copy</span>
        </button>
      </div>

      <!-- Agent cards for assigning KB -->
      <div class="w-full mt-4 space-y-2">
        <p class="text-[10px] uppercase tracking-widest text-slate-400 text-center mb-2">Assign research to agent</p>
        <div id="result-agents" class="space-y-2"></div>
      </div>

      <button onclick="App.showView('home')"
              class="w-full py-3 rounded-xl border border-slate-200 text-slate-500 text-center font-medium text-sm hover:bg-slate-50 transition-colors mt-2">
        New Research
      </button>
    </div>
  </div>

  <!-- ════════════ ERROR VIEW ════════════ -->
  <div id="view-error" class="view flex-1">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
    </header>
    <div class="flex-1 flex flex-col items-center justify-center gap-4">
      <span class="material-icons text-6xl text-red-400">error</span>
      <div class="text-lg font-semibold text-slate-700">Research Failed</div>
      <div id="error-msg" class="text-sm text-slate-400 text-center px-4"></div>
      <button onclick="App.retry()" class="w-full py-3 rounded-xl bg-primary text-white text-center font-semibold text-sm">Retry</button>
      <button onclick="App.showView('home')" class="w-full py-3 rounded-xl border border-slate-200 text-slate-500 text-center font-medium text-sm">New Research</button>
    </div>
  </div>

  <!-- ════════════ CHAT VIEW ════════════ -->
  <div id="view-chat" class="view flex-1">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <div class="flex items-center space-x-2 text-[10px] tracking-[0.2em] font-medium uppercase text-slate-400">
        <span class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></span>
        <span>Agents Online</span>
      </div>
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Research Agents</h1>
    </header>
    <div id="chat-agents" class="mt-6 space-y-3"></div>
  </div>

  <!-- ════════════ ARCHIVE VIEW ════════════ -->
  <div id="view-archive" class="view flex-1">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
      <p class="text-xs text-slate-400">Past Research</p>
    </header>
    <div id="archive-list" class="mt-4 space-y-2"></div>
  </div>


</main>

<!-- ════════════ BOTTOM NAV ════════════ -->
<nav id="bottom-nav" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50">
  <div class="glass-panel px-6 py-3 rounded-full flex items-center justify-between w-[280px] shadow-glass relative">
    <button class="nav-btn p-2 rounded-full hover:bg-slate-100 transition-colors group" data-view="archive">
      <span class="material-icons text-slate-400 group-hover:text-primary transition-colors text-xl">inventory_2</span>
    </button>
    <!-- Center raised chat button -->
    <button class="nav-btn relative -top-6 p-4 rounded-full bg-gradient-to-b from-white to-slate-100 shadow-lg border border-slate-100 group hover:-translate-y-1 transition-transform duration-300" data-view="chat">
      <div class="absolute inset-0 bg-primary/20 blur-md rounded-full group-hover:bg-primary/40 transition-colors"></div>
      <div class="relative z-10 w-10 h-10 flex items-center justify-center">
        <div class="w-full flex items-center justify-center gap-[2px] h-4">
          <div class="w-[3px] bg-primary rounded-full" style="height:100%;animation:pulse-bar 1s ease-in-out infinite"></div>
          <div class="w-[3px] bg-primary rounded-full" style="height:80%;animation:pulse-bar 1.2s ease-in-out infinite 0.1s"></div>
          <div class="w-[3px] bg-primary rounded-full" style="height:60%;animation:pulse-bar 0.8s ease-in-out infinite 0.2s"></div>
          <div class="w-[3px] bg-primary rounded-full" style="height:90%;animation:pulse-bar 1.1s ease-in-out infinite 0.3s"></div>
        </div>
      </div>
    </button>
    <button class="nav-btn p-2 rounded-full hover:bg-slate-100 transition-colors group" data-view="home">
      <span class="material-icons text-slate-400 group-hover:text-primary transition-colors text-xl">home</span>
    </button>
  </div>
</nav>

<!-- ════════════ CALL OVERLAY ════════════ -->
<div id="call-overlay" class="widget-overlay">
  <div class="flex flex-col items-center justify-between h-full max-w-sm w-full py-16 px-6">
    <!-- Agent info -->
    <div class="flex flex-col items-center">
      <div class="w-24 h-24 rounded-full bg-white/80 shadow-neumorphic flex items-center justify-center mb-4 relative">
        <span id="call-agent-icon" class="material-icons text-4xl text-primary">bolt</span>
        <!-- Pulsing ring when connected -->
        <div id="call-pulse-ring" class="absolute inset-0 rounded-full border-2 border-primary/40 hidden" style="animation:spin 3s linear infinite"></div>
      </div>
      <div id="call-agent-name" class="text-xl font-semibold text-slate-700"></div>
      <div id="call-agent-subtitle" class="text-xs text-slate-400 mt-1"></div>
    </div>

    <!-- Status + timer -->
    <div class="flex flex-col items-center gap-3">
      <div id="call-status" class="flex items-center gap-2">
        <div id="call-status-dot" class="w-2.5 h-2.5 rounded-full bg-amber-400 animate-pulse"></div>
        <span id="call-status-text" class="text-sm text-slate-500">Connecting...</span>
      </div>
      <div id="call-timer" class="text-2xl font-mono font-light text-slate-400 tabular-nums hidden">0:00</div>
      <!-- Audio bars visualization -->
      <div id="call-audio-viz" class="flex items-end justify-center gap-[3px] h-8 hidden">
        <div class="w-[4px] bg-primary/60 rounded-full" style="height:40%;animation:pulse-bar 0.8s ease-in-out infinite"></div>
        <div class="w-[4px] bg-primary/60 rounded-full" style="height:70%;animation:pulse-bar 1.0s ease-in-out infinite 0.1s"></div>
        <div class="w-[4px] bg-primary/60 rounded-full" style="height:100%;animation:pulse-bar 0.7s ease-in-out infinite 0.2s"></div>
        <div class="w-[4px] bg-primary/60 rounded-full" style="height:60%;animation:pulse-bar 0.9s ease-in-out infinite 0.15s"></div>
        <div class="w-[4px] bg-primary/60 rounded-full" style="height:80%;animation:pulse-bar 1.1s ease-in-out infinite 0.25s"></div>
      </div>
      <!-- Error message -->
      <div id="call-error" class="text-sm text-red-400 text-center hidden"></div>
    </div>

    <!-- End call button -->
    <button id="call-end-btn" onclick="App.endCall()"
            class="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center shadow-lg hover:bg-red-600 active:scale-95 transition-all">
      <span class="material-icons text-white text-3xl">call_end</span>
    </button>
  </div>
</div>

<script>
const App = (function() {
  /* ── State ── */
  let currentView = 'home';
  let selectedDepth = 'STANDARD';
  let currentJobId = null;
  let pollTimer = null;
  let elapsedTimer = null;
  let startTime = null;
  let lastQuery = '';
  let lastDocId = '';
  let lastDocName = '';
  let agentsData = [];

  /* ── Helpers ── */
  function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }

  /* ── View Navigation ── */
  function showView(name) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    const el = document.getElementById('view-' + name);
    if (el) el.classList.add('active');
    currentView = name;

    // Highlight active nav
    document.querySelectorAll('.nav-btn').forEach(b => {
      const icon = b.querySelector('.material-icons');
      if (icon) icon.classList.remove('text-primary');
      if (icon) icon.classList.add('text-slate-400');
    });
    const navBtn = document.querySelector(`.nav-btn[data-view="${name}"]`);
    if (navBtn) {
      const icon = navBtn.querySelector('.material-icons');
      if (icon) { icon.classList.remove('text-slate-400'); icon.classList.add('text-primary'); }
    }

    if (name === 'archive') loadArchive();
    if (name === 'chat') loadChatAgents();
    if (name === 'home') { loadStats(); updateBanner(); }
  }

  /* ── Bottom nav ── */
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => showView(btn.dataset.view));
  });

  /* ── Depth selector ── */
  document.querySelectorAll('.depth-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.depth-btn').forEach(b => {
        b.classList.remove('border-primary','text-primary','bg-primary/10');
        b.classList.add('border-slate-200','text-slate-400');
      });
      btn.classList.remove('border-slate-200','text-slate-400');
      btn.classList.add('border-primary','text-primary','bg-primary/10');
      selectedDepth = btn.dataset.depth;
    });
  });

  /* ── ACTIVATE ── */
  const activateBtn = document.getElementById('activate-btn');
  const queryInput = document.getElementById('query-input');
  let estimatedSeconds = 300;
  let suggestedQuery = '';

  activateBtn.addEventListener('click', async () => {
    const query = queryInput.value.trim();
    if (!query) { queryInput.focus(); return; }

    activateBtn.disabled = true;
    lastQuery = query;

    try {
      // For DEEP: validate query clarity first
      if (selectedDepth === 'DEEP') {
        document.getElementById('phase-text').textContent = 'Evaluating query clarity...';
        const valRes = await fetch('/api/research/validate', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ query, depth: selectedDepth })
        });
        const val = await valRes.json();

        if (!val.clear) {
          // Show validation view
          document.getElementById('validate-feedback').textContent = val.feedback || 'Your query could be more specific.';
          const sugBox = document.getElementById('validate-suggested');
          const sugBtn = document.getElementById('validate-use-suggested');
          if (val.suggested_query) {
            suggestedQuery = val.suggested_query;
            document.getElementById('validate-suggested-text').textContent = val.suggested_query;
            sugBox.classList.remove('hidden');
            sugBtn.classList.remove('hidden');
          } else {
            sugBox.classList.add('hidden');
            sugBtn.classList.add('hidden');
          }
          showView('validate');
          activateBtn.disabled = false;
          return;
        }
      }

      await launchResearch(query);
    } catch(e) {
      alert('Failed to start: ' + e.message);
    } finally {
      activateBtn.disabled = false;
    }
  });

  async function launchResearch(query) {
    const res = await fetch('/api/research', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ query, depth: selectedDepth })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Request failed');

    currentJobId = data.job_id;
    estimatedSeconds = data.estimated_seconds || 300;
    startTime = Date.now();

    // Persist to localStorage
    localStorage.setItem('activeJob', JSON.stringify({
      jobId: currentJobId,
      query: query,
      depth: selectedDepth,
      startTime: startTime,
      estimatedSeconds: estimatedSeconds,
    }));

    // Set start/ETA times in progress bar
    const now = new Date();
    const eta = new Date(now.getTime() + estimatedSeconds * 1000);
    document.getElementById('progress-start').textContent = now.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',hour12:false});
    document.getElementById('progress-eta').textContent = eta.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',hour12:false});

    // Reset progress trackers
    pipelineRendered = false;
    document.getElementById('study-tracker').classList.add('hidden');
    document.getElementById('pipeline-steps').classList.add('hidden');
    document.getElementById('study-list').innerHTML = '';
    document.getElementById('step-list').innerHTML = '';
    document.getElementById('phase-text').textContent = 'Starting...';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-pct').textContent = '0%';

    showView('progress');
    startPolling();
  }

  function useSuggested() {
    if (suggestedQuery) {
      queryInput.value = suggestedQuery;
      lastQuery = suggestedQuery;
    }
    forceStart();
  }

  async function forceStart() {
    activateBtn.disabled = true;
    try {
      await launchResearch(lastQuery);
    } catch(e) {
      alert('Failed to start: ' + e.message);
      showView('home');
    } finally {
      activateBtn.disabled = false;
    }
  }

  // Also activate on Enter
  queryInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') activateBtn.click();
  });

  /* ── Polling ── */
  // Historical timing data for smart estimates
  let historicalTimings = null;  // {phase_averages: {planning: 30, studies: 1200, ...}, total_average: 2400}
  const PHASE_ORDER = ['planning', 'studies', 'synthesis', 'evaluation', 'refinement', 'strategic_analysis', 'qa', 'upload'];

  async function fetchTimingEstimates() {
    try {
      const res = await fetch('/api/timing-estimates');
      if (res.ok) {
        historicalTimings = await res.json();
        if (historicalTimings.total_average > 0) {
          estimatedSeconds = historicalTimings.total_average;
        }
      }
    } catch(e) { /* use default */ }
  }

  function startPolling() {
    if (!startTime) startTime = Date.now();
    if (selectedDepth === 'DEEP') fetchTimingEstimates();
    updateTimers();
    elapsedTimer = setInterval(updateTimers, 1000);
    poll();
    pollTimer = setInterval(poll, 3000);
  }

  function stopPolling() {
    clearInterval(pollTimer); clearInterval(elapsedTimer);
    pollTimer = null; elapsedTimer = null;
  }

  function fmtTime(secs) {
    if (secs < 0) secs = 0;
    const m = Math.floor(secs / 60);
    const s = Math.floor(secs % 60);
    return m + ':' + String(s).padStart(2, '0');
  }

  let currentPhaseTimings = {};  // live timings from status API

  function computeSmartEstimate() {
    // If no historical data, fall back to static estimate
    if (!historicalTimings || !historicalTimings.phase_averages || historicalTimings.sample_count === 0) {
      const elapsedSecs = (Date.now() - startTime) / 1000;
      return Math.max(0, estimatedSeconds - elapsedSecs);
    }
    const avgs = historicalTimings.phase_averages;
    // Sum up expected remaining time from phases not yet completed
    let remaining = 0;
    let foundCurrent = false;
    for (const phase of PHASE_ORDER) {
      const avg = avgs[phase] || 0;
      const live = currentPhaseTimings[phase];
      if (live && live.duration) {
        // Phase completed — already elapsed, skip
        continue;
      } else if (live && live.start && !live.end) {
        // Currently in this phase — remaining = avg - time_spent_so_far
        foundCurrent = true;
        const spent = Date.now() / 1000 - live.start;
        remaining += Math.max(0, avg - spent);
      } else if (foundCurrent || (!live && !foundCurrent)) {
        // Haven't reached this phase yet — if we're past it in PHASE_ORDER and have a current,
        // add full average. If we haven't found current yet, this phase may have been skipped.
        if (foundCurrent) {
          remaining += avg;
        }
      }
    }
    return remaining;
  }

  function updateTimers() {
    if (!startTime) return;
    const elapsedSecs = (Date.now() - startTime) / 1000;
    const remaining = computeSmartEstimate();
    const totalEst = elapsedSecs + remaining;
    const pct = totalEst > 0 ? Math.min(99, (elapsedSecs / totalEst) * 100) : 0;

    document.getElementById('elapsed').textContent = fmtTime(elapsedSecs);
    document.getElementById('countdown').textContent = remaining > 0 ? fmtTime(remaining) : 'Any moment...';
    document.getElementById('progress-bar').style.width = pct.toFixed(1) + '%';
    document.getElementById('progress-pct').textContent = Math.floor(pct) + '%';

    // Also update banner countdown
    const bc = document.getElementById('banner-countdown');
    if (bc) bc.textContent = remaining > 0 ? fmtTime(remaining) : 'finishing';
  }

  let lastPhase = '';
  const PIPELINE_STEPS = [
    {id:'planning', label:'Planning studies', icon:'psychology'},
    {id:'studies', label:'Researching studies', icon:'science'},
    {id:'synthesis', label:'Master synthesis', icon:'auto_awesome'},
    {id:'evaluation', label:'Quality evaluation', icon:'fact_check'},
    {id:'refinement', label:'Refining synthesis', icon:'refresh'},
    {id:'strategic_analysis', label:'Strategic frameworks', icon:'analytics'},
    {id:'qa', label:'Anticipated Q&A', icon:'forum'},
  ];
  let pipelineRendered = false;

  function renderStudyTracker(studyProgress) {
    const tracker = document.getElementById('study-tracker');
    const list = document.getElementById('study-list');
    if (!studyProgress || !studyProgress.length) { tracker.classList.add('hidden'); return; }
    tracker.classList.remove('hidden');
    const done = studyProgress.filter(s => s.status === 'done').length;
    const running = studyProgress.filter(s => s.status === 'running').length;
    list.innerHTML = studyProgress.map((s, i) => {
      let statusIcon, textClass;
      if (s.status === 'done') {
        statusIcon = '<span class="material-icons text-emerald-500 text-sm">check_circle</span>';
        textClass = 'text-emerald-700';
      } else if (s.status === 'running') {
        statusIcon = '<div class="w-4 h-4 border-2 border-slate-200 border-t-primary rounded-full flex-shrink-0" style="animation:spin 1s linear infinite"></div>';
        textClass = 'text-slate-700 font-medium';
      } else if (s.status === 'failed') {
        statusIcon = '<span class="material-icons text-red-400 text-sm">error</span>';
        textClass = 'text-red-500';
      } else {
        statusIcon = '<span class="material-icons text-slate-300 text-sm">radio_button_unchecked</span>';
        textClass = 'text-slate-400';
      }
      return `<div class="flex items-center gap-2 px-1">${statusIcon}<span class="text-xs ${textClass} truncate">${s.title || 'Study '+(i+1)}</span></div>`;
    }).join('');
  }

  function normalizePipelineStep(step) {
    if (!step) return step;
    if (step.startsWith('study_')) return 'studies';
    return step;
  }

  function renderPipelineSteps(currentStep) {
    const container = document.getElementById('pipeline-steps');
    const list = document.getElementById('step-list');
    const normalized = normalizePipelineStep(currentStep);
    if (!normalized && !pipelineRendered) return;
    container.classList.remove('hidden');
    pipelineRendered = true;
    const stepIdx = PIPELINE_STEPS.findIndex(s => s.id === normalized);
    list.innerHTML = PIPELINE_STEPS.map((s, i) => {
      let icon, textClass;
      if (i < stepIdx) { icon = `<span class="material-icons text-emerald-500 text-sm">check_circle</span>`; textClass = 'text-emerald-700'; }
      else if (i === stepIdx) { icon = `<div class="w-4 h-4 border-2 border-slate-200 border-t-primary rounded-full flex-shrink-0" style="animation:spin 1s linear infinite"></div>`; textClass = 'text-slate-700 font-medium'; }
      else { icon = `<span class="material-icons text-slate-300 text-sm">radio_button_unchecked</span>`; textClass = 'text-slate-400'; }
      return `<div class="flex items-center gap-2 px-1">${icon}<span class="material-icons ${textClass} text-sm">${s.icon}</span><span class="text-xs ${textClass}">${s.label}</span></div>`;
    }).join('');
  }

  async function poll() {
    if (!currentJobId) return;
    try {
      const res = await fetch('/api/status/' + currentJobId);
      if (!res.ok) {
        // Job not found (e.g. after redeployment) — clean up stale state
        if (res.status === 404) {
          stopPolling();
          localStorage.removeItem('activeJob');
          currentJobId = null;
          updateBanner();
          document.getElementById('error-msg').textContent = 'Research session was lost (server restarted). Please start a new one.';
          showView('error');
        }
        return;
      }
      const data = await res.json();

      const phase = data.phase || 'Working...';
      document.getElementById('phase-text').textContent = phase;
      // Update banner phase
      const bp = document.getElementById('banner-phase');
      if (bp) bp.textContent = phase;

      // Capture live phase timings for smart estimates
      if (data.phase_timings) currentPhaseTimings = data.phase_timings;

      // Render study tracker and pipeline steps for DEEP
      if (data.study_progress && data.study_progress.length) {
        renderStudyTracker(data.study_progress);
      }
      if (data.current_step) {
        renderPipelineSteps(data.current_step);
      }

      // Mid-research status check
      const midIcon = document.getElementById('mid-check-icon');
      const midText = document.getElementById('mid-check-text');
      if (data.status === 'running') {
        if (phase !== lastPhase && lastPhase) {
          midIcon.className = 'w-2 h-2 rounded-full bg-primary animate-pulse';
          midText.textContent = 'Phase update: ' + phase;
        } else {
          midIcon.className = 'w-2 h-2 rounded-full bg-primary animate-pulse';
          midText.textContent = 'Pipeline running normally';
        }
      }
      lastPhase = phase;

      if (data.status === 'completed') {
        stopPolling();
        localStorage.removeItem('activeJob');
        currentJobId = null;
        updateBanner();
        document.getElementById('progress-bar').style.width = '100%';
        document.getElementById('progress-pct').textContent = '100%';
        document.getElementById('countdown').textContent = '0:00';
        lastDocId = data.elevenlabs_doc_id || '';
        lastDocName = 'Research: ' + (data.query||'').substring(0,60);
        document.getElementById('result-query').textContent = data.query;
        const link = document.getElementById('result-link');
        if (data.result_url) { link.href = data.result_url; link.style.display = 'block'; }
        else { link.style.display = 'none'; }
        renderResultAgents();
        setTimeout(() => showView('result'), 600);
      } else if (data.status === 'failed') {
        stopPolling();
        localStorage.removeItem('activeJob');
        currentJobId = null;
        updateBanner();
        midIcon.className = 'w-2 h-2 rounded-full bg-red-400';
        midText.textContent = 'Error: ' + (data.error || 'Unknown error');
        midText.classList.add('text-red-500');
        document.getElementById('error-msg').textContent = data.error || 'An unknown error occurred';
        setTimeout(() => showView('error'), 1500);
      }
    } catch(e) { /* keep polling */ }
  }

  /* ── Shared agent card renderer ── */
  function renderAgentCard(a, mode) {
    // mode: 'attach' (result view — assign + chat) or 'chat' (chat view — chat only)
    const docs = a.kb_docs || [];
    const kbHtml = docs.length
      ? docs.slice(0, 3).map(d => {
          const label = (d.name || d.id || '').replace(/^Research:\s*/i, '').substring(0, 50);
          return `<span class="kb-tag">${esc(label)}</span>`;
        }).join('') + (docs.length > 3 ? `<span class="kb-tag">+${docs.length - 3} more</span>` : '')
      : '<span class="text-[10px] text-slate-300 italic">No research loaded</span>';

    if (mode === 'chat') {
      // Chat view: simple card, opens widget directly
      return `<div class="agent-card agent-${esc(a.color)}" onclick="App.startCall('${esc(a.agent_id)}','${esc(a.name)}')">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 rounded-full bg-white/80 shadow-inner-chrome flex items-center justify-center flex-shrink-0">
            <span class="material-icons agent-icon text-xl">${esc(a.icon)}</span>
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <span class="font-semibold text-slate-700 text-sm">${esc(a.name)}</span>
              <span class="agent-dot"></span>
            </div>
            <div class="text-[11px] text-slate-400">${esc(a.subtitle)}</div>
          </div>
          <span class="material-icons text-slate-300 text-lg">chat</span>
        </div>
        <div class="flex flex-wrap gap-1 ml-[52px]">${kbHtml}</div>
      </div>`;
    }

    // Attach mode (result view): assign button + separate chat button
    const cardId = 'agent-card-' + a.slug;
    return `<div id="${cardId}" class="agent-card agent-${esc(a.color)}">
      <div class="flex items-center gap-3 mb-2">
        <div class="w-10 h-10 rounded-full bg-white/80 shadow-inner-chrome flex items-center justify-center flex-shrink-0">
          <span class="material-icons agent-icon text-xl">${esc(a.icon)}</span>
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2">
            <span class="font-semibold text-slate-700 text-sm">${esc(a.name)}</span>
            <span class="agent-dot"></span>
          </div>
          <div class="text-[11px] text-slate-400">${esc(a.subtitle)}</div>
        </div>
      </div>
      <div class="flex flex-wrap gap-1 ml-[52px] mb-2">${kbHtml}</div>
      <div id="${cardId}-actions" class="flex gap-2 ml-[52px]">
        <button onclick="App.assignToAgent('${esc(a.slug)}','${esc(a.agent_id)}','${esc(a.name)}')"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-semibold text-white bg-gradient-to-r from-primary to-cyan-400 hover:opacity-90 transition-opacity">
          <span class="material-icons text-sm">add_circle</span> Assign Research
        </button>
        <button onclick="App.startCall('${esc(a.agent_id)}','${esc(a.name)}')"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-medium text-slate-500 border border-slate-200 hover:bg-slate-50 transition-colors">
          <span class="material-icons text-sm">chat</span> Chat
        </button>
      </div>
    </div>`;
  }

  /* ── Result: agent cards ── */
  async function renderResultAgents() {
    const container = document.getElementById('result-agents');
    if (!lastDocId) {
      container.innerHTML = '<p class="text-xs text-slate-400 text-center">No KB document available for chat</p>';
      return;
    }
    try {
      const res = await fetch('/api/agents');
      const data = await res.json();
      agentsData = data.agents || [];
      container.innerHTML = agentsData.map(a => renderAgentCard(a, 'attach')).join('');
    } catch(e) {
      container.innerHTML = '<p class="text-xs text-red-400 text-center">Failed to load agents</p>';
    }
  }

  /* ── Assign research to agent (with visual feedback) ── */
  async function assignToAgent(slug, agentId, agentName) {
    if (!agentId) { alert('Agent not configured'); return; }

    const cardId = 'agent-card-' + slug;
    const actionsEl = document.getElementById(cardId + '-actions');
    if (!actionsEl) return;

    if (!lastDocId) {
      actionsEl.innerHTML = `<div class="flex items-center gap-2 text-[11px] text-amber-500">
        <span class="material-icons text-sm">warning</span> No research document available to assign
      </div>`;
      return;
    }

    // Show loading state
    actionsEl.innerHTML = `<div class="flex items-center gap-2 text-[11px] text-slate-400">
      <div class="w-4 h-4 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 0.8s linear infinite"></div>
      Assigning research to ${esc(agentName)}...
    </div>`;

    try {
      const res = await fetch(`/api/agents/${slug}/attach`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ doc_id: lastDocId, doc_name: lastDocName })
      });
      const data = await res.json();

      if (res.ok) {
        // Show success
        actionsEl.innerHTML = `<div class="flex items-center gap-2 text-[11px] text-emerald-600 font-semibold">
          <span class="material-icons text-sm">check_circle</span> Research assigned to ${esc(agentName)}!
        </div>
        <button onclick="App.startCall('${esc(agentId)}','${esc(agentName)}')"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-semibold text-white bg-gradient-to-r from-primary to-cyan-400 hover:opacity-90 transition-opacity mt-2">
          <span class="material-icons text-sm">chat</span> Chat with ${esc(agentName)}
        </button>`;
      } else {
        actionsEl.innerHTML = `<div class="flex items-center gap-2 text-[11px] text-red-500">
          <span class="material-icons text-sm">error</span> Failed: ${esc(data.error || 'Unknown error')}
        </div>
        <button onclick="App.assignToAgent('${esc(slug)}','${esc(agentId)}','${esc(agentName)}')"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-medium text-slate-500 border border-slate-200 hover:bg-slate-50 transition-colors mt-1">
          Retry
        </button>`;
      }
    } catch(e) {
      actionsEl.innerHTML = `<div class="flex items-center gap-2 text-[11px] text-red-500">
        <span class="material-icons text-sm">error</span> Connection failed
      </div>
      <button onclick="App.assignToAgent('${esc(slug)}','${esc(agentId)}','${esc(agentName)}')"
              class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-medium text-slate-500 border border-slate-200 hover:bg-slate-50 transition-colors mt-1">
        Retry
      </button>`;
    }
  }

  /* ── Chat view: agent cards ── */
  async function loadChatAgents() {
    const container = document.getElementById('chat-agents');
    container.innerHTML = '<div class="flex justify-center py-8"><div class="w-6 h-6 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 0.8s linear infinite"></div></div>';

    try {
      const res = await fetch('/api/agents');
      const data = await res.json();
      agentsData = data.agents || [];

      container.innerHTML = agentsData.map(a => renderAgentCard(a, 'chat')).join('');
    } catch(e) {
      container.innerHTML = '<p class="text-sm text-red-400 text-center py-8">Failed to load agents</p>';
    }
  }

  /* ── Voice Call (ElevenLabs SDK) ── */
  let activeConversation = null;
  let callTimerInterval = null;
  let callStartTime = null;

  async function startCall(agentId, agentName) {
    if (!agentId) { alert('Agent not configured'); return; }

    // Find agent metadata for icon/color/subtitle
    const agent = agentsData.find(a => a.agent_id === agentId) || {};

    // Show call overlay in connecting state
    document.getElementById('call-agent-icon').textContent = agent.icon || 'mic';
    document.getElementById('call-agent-icon').style.color = `var(--ac)`;
    document.getElementById('call-agent-icon').closest('.agent-cyan, .agent-amber, .agent-violet, [class]'); // fallback
    const iconEl = document.getElementById('call-agent-icon');
    const colorMap = { cyan: '#0dccf2', amber: '#f59e0b', violet: '#8b5cf6' };
    iconEl.style.color = colorMap[agent.color] || '#0dccf2';

    document.getElementById('call-agent-name').textContent = agentName || 'Agent';
    document.getElementById('call-agent-subtitle').textContent = agent.subtitle || '';
    document.getElementById('call-status-dot').className = 'w-2.5 h-2.5 rounded-full bg-amber-400 animate-pulse';
    document.getElementById('call-status-text').textContent = 'Connecting...';
    document.getElementById('call-timer').classList.add('hidden');
    document.getElementById('call-audio-viz').classList.add('hidden');
    document.getElementById('call-pulse-ring').classList.add('hidden');
    document.getElementById('call-error').classList.add('hidden');
    document.getElementById('call-overlay').classList.add('active');

    try {
      const { Conversation } = await import('https://cdn.jsdelivr.net/npm/@elevenlabs/client@0.14.0/+esm');

      activeConversation = await Conversation.startSession({
        agentId: agentId,
        onConnect: () => {
          document.getElementById('call-status-dot').className = 'w-2.5 h-2.5 rounded-full bg-emerald-400';
          document.getElementById('call-status-text').textContent = 'Connected';
          document.getElementById('call-timer').classList.remove('hidden');
          document.getElementById('call-audio-viz').classList.remove('hidden');
          document.getElementById('call-pulse-ring').classList.remove('hidden');
          callStartTime = Date.now();
          callTimerInterval = setInterval(updateCallTimer, 1000);
        },
        onDisconnect: () => {
          document.getElementById('call-status-dot').className = 'w-2.5 h-2.5 rounded-full bg-slate-300';
          document.getElementById('call-status-text').textContent = 'Call ended';
          document.getElementById('call-audio-viz').classList.add('hidden');
          document.getElementById('call-pulse-ring').classList.add('hidden');
          clearInterval(callTimerInterval);
          activeConversation = null;
          setTimeout(() => {
            document.getElementById('call-overlay').classList.remove('active');
          }, 1500);
        },
        onError: (error) => {
          console.error('Call error:', error);
          document.getElementById('call-status-dot').className = 'w-2.5 h-2.5 rounded-full bg-red-400';
          document.getElementById('call-status-text').textContent = 'Error';
          const errEl = document.getElementById('call-error');
          errEl.textContent = error.message || 'Connection failed';
          errEl.classList.remove('hidden');
          document.getElementById('call-audio-viz').classList.add('hidden');
        },
      });
    } catch(e) {
      console.error('Failed to start call:', e);
      document.getElementById('call-status-dot').className = 'w-2.5 h-2.5 rounded-full bg-red-400';
      document.getElementById('call-status-text').textContent = 'Failed to connect';
      const errEl = document.getElementById('call-error');
      errEl.textContent = e.message || 'Could not load voice SDK';
      errEl.classList.remove('hidden');
    }
  }

  function updateCallTimer() {
    if (!callStartTime) return;
    const secs = Math.floor((Date.now() - callStartTime) / 1000);
    const m = Math.floor(secs / 60);
    const s = secs % 60;
    document.getElementById('call-timer').textContent = m + ':' + String(s).padStart(2, '0');
  }

  async function endCall() {
    clearInterval(callTimerInterval);
    if (activeConversation) {
      try { await activeConversation.endSession(); } catch(e) { /* ignore */ }
      activeConversation = null;
    }
    document.getElementById('call-overlay').classList.remove('active');
  }

  /* ── Archive ── */
  async function loadArchive() {
    const container = document.getElementById('archive-list');
    container.innerHTML = '<div class="flex justify-center py-8"><div class="w-6 h-6 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 0.8s linear infinite"></div></div>';

    try {
      const res = await fetch('/api/archive');
      const data = await res.json();
      const results = data.results || [];

      if (!results.length) {
        container.innerHTML = '<div class="flex flex-col items-center justify-center py-12 text-slate-400"><span class="material-icons text-4xl mb-2 opacity-40">science</span><p class="text-sm">No research yet</p></div>';
        return;
      }

      container.innerHTML = results.map(r => {
        const date = r.completed_at ? new Date(r.completed_at).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
        const studies = r.num_studies ? r.num_studies + ' studies' : '';
        const docId = r.elevenlabs_doc_id || '';
        return `<div class="glass-panel rounded-xl p-4 shadow-glass border border-white/60 space-y-2">
          <div class="cursor-pointer" onclick="window.open('${esc(r.result_url||'')}','_blank')">
            <h3 class="font-semibold text-sm text-slate-700 line-clamp-2">${esc(r.query||'Untitled')}</h3>
            <div class="flex gap-3 text-[11px] text-slate-400 mt-1">
              <span class="bg-primary/10 text-primary px-2 py-0.5 rounded-md font-semibold">${esc(r.depth||'')}</span>
              ${studies ? '<span>'+studies+'</span>' : ''}
              ${date ? '<span>'+date+'</span>' : ''}
            </div>
          </div>
          <div class="flex items-center gap-3">
            ${docId ? `<button onclick="App.archiveChat('${esc(docId)}','${esc((r.query||'').substring(0,60))}')" class="text-[11px] text-primary font-medium flex items-center gap-1 hover:underline"><span class="material-icons text-sm">chat</span>Chat about this</button>` : ''}
            ${r.result_url ? `<button onclick="navigator.clipboard.writeText('${esc(r.result_url)}');this.querySelector('.material-icons').textContent='check';setTimeout(()=>this.querySelector('.material-icons').textContent='content_copy',1500)" class="text-[11px] text-slate-400 font-medium flex items-center gap-1 hover:text-primary transition-colors"><span class="material-icons text-sm">content_copy</span>Copy URL</button>` : ''}
          </div>
        </div>`;
      }).join('');
    } catch(e) {
      container.innerHTML = '<div class="flex flex-col items-center justify-center py-12 text-slate-400"><span class="material-icons text-4xl mb-2 opacity-40">cloud_off</span><p class="text-sm">Failed to load archive</p></div>';
    }
  }

  /* ── Archive chat: show agent picker ── */
  function archiveChat(docId, docName) {
    lastDocId = docId;
    lastDocName = 'Research: ' + docName;
    // Show result view with agent cards
    document.getElementById('result-query').textContent = docName;
    document.getElementById('result-link').style.display = 'none';
    renderResultAgents();
    showView('result');
  }

  /* ── Copy report URL ── */
  function copyReportUrl() {
    const link = document.getElementById('result-link');
    const url = link ? link.href : '';
    if (!url || url === '#' || url.endsWith('#')) return;
    navigator.clipboard.writeText(url).then(() => {
      const btn = document.getElementById('copy-url-btn');
      const icon = btn.querySelector('.material-icons');
      icon.textContent = 'check';
      btn.classList.add('text-emerald-500', 'border-emerald-300');
      setTimeout(() => {
        icon.textContent = 'content_copy';
        btn.classList.remove('text-emerald-500', 'border-emerald-300');
      }, 2000);
    }).catch(() => {
      // Fallback for older browsers
      prompt('Copy this URL:', url);
    });
  }

  /* ── Stats ── */
  async function loadStats() {
    try {
      const res = await fetch('/api/stats');
      const data = await res.json();
      document.getElementById('stat-researching').textContent = String(data.researching||0).padStart(2,'0');
      document.getElementById('stat-completed').textContent = data.completed || 0;
    } catch(e) { /* silent */ }

    // Agent KB counts
    try {
      const res = await fetch('/api/agents');
      const data = await res.json();
      for (const a of (data.agents || [])) {
        const el = document.getElementById('kb-' + a.slug);
        if (el) el.textContent = String(a.kb_count).padStart(2, '0');
      }
    } catch(e) { /* silent */ }
  }

  /* ── Retry ── */
  function retry() {
    queryInput.value = lastQuery;
    showView('home');
  }

  /* ── Banner ── */
  function updateBanner() {
    const banner = document.getElementById('active-research-banner');
    if (!banner) return;
    if (currentJobId) {
      document.getElementById('banner-query').textContent = lastQuery || 'Research in progress';
      banner.classList.remove('hidden');
    } else {
      banner.classList.add('hidden');
    }
  }

  function resumeProgress() {
    if (currentJobId) showView('progress');
  }

  /* ── Init ── */
  loadStats();
  setInterval(loadStats, 30000);

  // Restore active job from localStorage (survives page refresh)
  (async function restoreActiveJob() {
    const saved = localStorage.getItem('activeJob');
    if (!saved) return;
    try {
      const job = JSON.parse(saved);
      if (!job.jobId) { localStorage.removeItem('activeJob'); return; }

      // Check if the job is still running
      const res = await fetch('/api/status/' + job.jobId);
      if (!res.ok) { localStorage.removeItem('activeJob'); return; }
      const data = await res.json();

      if (data.status === 'running') {
        // Restore state and show banner
        currentJobId = job.jobId;
        lastQuery = job.query || '';
        selectedDepth = job.depth || 'STANDARD';
        startTime = job.startTime || Date.now();
        estimatedSeconds = job.estimatedSeconds || 300;

        // Update progress view times
        const start = new Date(startTime);
        const eta = new Date(startTime + estimatedSeconds * 1000);
        document.getElementById('progress-start').textContent = start.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',hour12:false});
        document.getElementById('progress-eta').textContent = eta.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',hour12:false});

        updateBanner();
        startPolling();
      } else {
        // Job already finished, clean up
        localStorage.removeItem('activeJob');
      }
    } catch(e) {
      localStorage.removeItem('activeJob');
    }
  })();

  /* ── Public API ── */
  return { showView, retry, assignToAgent, startCall, endCall, archiveChat, copyReportUrl, useSuggested, forceStart, resumeProgress };
})();
</script>
</body>
</html>
