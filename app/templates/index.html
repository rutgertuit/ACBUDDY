<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ACBUDDY Lab</title>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        "primary": "#0dccf2",
        "primary-glow": "rgba(13,204,242,0.4)",
        "bg": "#f5f8f8",
        "chrome": "#e2e8e8",
      },
      fontFamily: { display: ["Inter","sans-serif"] },
      borderRadius: { DEFAULT:"1rem", lg:"2rem", xl:"3rem", full:"9999px" },
      boxShadow: {
        glass: "0 8px 32px 0 rgba(31,38,135,0.07)",
        glow: "0 0 20px rgba(13,204,242,0.5), 0 0 60px rgba(13,204,242,0.2)",
        "inner-chrome": "inset 0 2px 4px 0 rgba(255,255,255,0.9), inset 0 -2px 4px 0 rgba(0,0,0,0.1)",
        neumorphic: "20px 20px 60px #d1d9d9, -20px -20px 60px #ffffff",
      },
      backgroundImage: {
        "chrome-gradient": "linear-gradient(135deg, #ffffff 0%, #f0f4f4 50%, #dce3e3 100%)",
      },
    },
  },
}
</script>
<style>
  body { min-height: 100dvh; background: #f5f8f8; }
  .glass-panel {
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.8);
  }
  .view { display:none; flex-direction:column; }
  .view.active { display:flex; }
  @keyframes shimmer { 0%{transform:translateX(-100%)} 100%{transform:translateX(300%)} }
  @keyframes spin { to{transform:rotate(360deg)} }
  @keyframes pulse-bar { 0%,100%{transform:scaleY(0.5)} 50%{transform:scaleY(1)} }

  /* Agent card — neumorphic glass style */
  .agent-cyan { --ac: #0dccf2; }
  .agent-amber { --ac: #f59e0b; }
  .agent-violet { --ac: #8b5cf6; }
  .agent-card {
    background: rgba(255,255,255,0.5);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.7);
    border-radius: 1.25rem;
    padding: 1.25rem;
    cursor: pointer;
    transition: all 0.25s;
    box-shadow: 6px 6px 16px #d1d9d9, -6px -6px 16px #ffffff;
  }
  .agent-card:hover { transform: translateY(-3px); box-shadow: 8px 8px 20px #c8d0d0, -8px -8px 20px #ffffff; }
  .agent-card:active { transform: scale(0.98); }
  .agent-card .agent-icon { color: var(--ac); }
  .agent-card .agent-accent { color: var(--ac); }
  .agent-card .agent-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--ac); box-shadow: 0 0 8px var(--ac); }
  .agent-card .kb-tag {
    display: inline-block; font-size: 10px; padding: 2px 8px; border-radius: 6px;
    background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05);
    color: #64748b; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }

  /* Widget overlay */
  .widget-overlay {
    position: fixed; inset:0; z-index:200;
    background: rgba(245,248,248,0.92);
    backdrop-filter: blur(12px);
    display: none; flex-direction: column; align-items: center; justify-content: center;
  }
  .widget-overlay.active { display: flex; }

  /* Call overlay pulse */
  @keyframes call-ring { 0%{transform:scale(1);opacity:0.4} 100%{transform:scale(1.3);opacity:0} }
  #call-pulse-ring:not(.hidden) { animation: call-ring 2s ease-out infinite; }

  /* Research stats */
  @keyframes count-up { from{opacity:0.5;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }
  .stat-flash { animation: count-up 0.3s ease-out; }
  .stats-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
  .stat-card {
    background: rgba(255,255,255,0.5);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.7);
    border-radius: 12px; padding: 8px 6px; text-align: center;
  }
  .stat-value { font-size:1.15rem; font-weight:700; font-variant-numeric:tabular-nums; line-height:1.2; }
  .stat-label { font-size:9px; text-transform:uppercase; letter-spacing:0.08em; color:#94a3b8; margin-top:2px; }

  /* Archive expand/collapse */
  .archive-item { cursor: pointer; transition: box-shadow 0.2s; }
  .archive-item:hover { box-shadow: 0 8px 32px 0 rgba(31,38,135,0.12); }
  .archive-item.expanded { box-shadow: 0 8px 32px 0 rgba(13,204,242,0.10); border-color: rgba(13,204,242,0.25); }
  .archive-detail {
    max-height: 0; overflow: hidden; opacity: 0;
    transition: max-height 0.35s ease, opacity 0.25s ease, padding 0.25s ease;
    padding: 0 16px;
  }
  .archive-detail.open {
    max-height: 800px; opacity: 1; padding: 12px 16px 16px;
  }
  .archive-chevron { transition: transform 0.25s; }
  .archive-item.expanded .archive-chevron { transform: rotate(180deg); }
  .archive-agent-row {
    background: rgba(255,255,255,0.5); backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.7); border-radius: 10px;
    padding: 10px 12px; transition: all 0.2s;
  }
  .archive-agent-row:hover { background: rgba(255,255,255,0.7); }
  .archive-countdown {
    background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2);
    border-radius: 8px; padding: 8px 12px;
  }

  /* Parallel cluster node */
  @keyframes node-pulse { 0%,100%{box-shadow:0 0 0 0 rgba(13,204,242,0.3)} 50%{box-shadow:0 0 0 6px rgba(13,204,242,0)} }
  .cluster-node { border-radius:10px; padding:4px 10px; font-size:11px; transition:all 0.3s; }
  .cluster-node.active { background:rgba(13,204,242,0.1); border:1px solid rgba(13,204,242,0.3); color:#0891b2; animation:node-pulse 2s infinite; }
  .cluster-node.done { background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); color:#059669; }
  .cluster-node.pending { background:rgba(0,0,0,0.03); border:1px solid rgba(0,0,0,0.06); color:#94a3b8; }
  .cluster-node.failed { background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3); color:#dc2626; }

  /* Human hours hero */
  .human-hours-hero {
    background: linear-gradient(135deg, rgba(13,204,242,0.08), rgba(139,92,246,0.08));
    border: 1px solid rgba(13,204,242,0.15);
    border-radius: 14px; padding: 10px 16px; text-align: center;
  }
</style>
</head>
<body class="font-display text-slate-600 flex flex-col items-center overflow-x-hidden">

<!-- Background blurs -->
<div class="fixed inset-0 pointer-events-none overflow-hidden">
  <div class="absolute top-[-20%] left-[-10%] w-[500px] h-[500px] bg-primary/5 rounded-full blur-[100px]"></div>
  <div class="absolute bottom-[-10%] right-[-10%] w-[400px] h-[400px] bg-primary/10 rounded-full blur-[80px]"></div>
  <div class="absolute inset-0 opacity-[0.03]" style="background-image:radial-gradient(#0dccf2 1px,transparent 1px);background-size:40px 40px"></div>
</div>

<main class="relative z-10 w-full max-w-md min-h-screen flex flex-col px-6 sm:px-8 pb-28">

  <!-- ════════════ HOME VIEW ════════════ -->
  <div id="view-home" class="view active flex-1">
    <!-- Header -->
    <header class="flex flex-col items-center mt-6 space-y-2 opacity-80">
      <div class="flex items-center space-x-2 text-[10px] tracking-[0.2em] font-medium uppercase text-slate-400">
        <span class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></span>
        <span>System Online</span>
      </div>
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
      <div class="flex items-center space-x-12 mt-4">
        <div class="flex flex-col items-center">
          <span class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">Researching</span>
          <div class="flex items-center space-x-1">
            <span class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></span>
            <span id="stat-researching" class="text-lg font-medium text-slate-700">00</span>
          </div>
        </div>
        <div class="w-px h-8 bg-gradient-to-b from-transparent via-slate-200 to-transparent"></div>
        <div class="flex flex-col items-center">
          <span class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">Completed</span>
          <div class="flex items-center space-x-1">
            <span class="material-icons text-[10px] text-primary">check_circle</span>
            <span id="stat-completed" class="text-lg font-medium text-slate-700">0</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Active research banners (one per running job) -->
    <div id="active-jobs-banners" class="space-y-2 mt-4"></div>

    <!-- Input + Button -->
    <div class="flex-1 flex flex-col items-center justify-center w-full space-y-10 -mt-4">
      <!-- Glass input panel -->
      <div class="w-full relative group transform transition-all duration-300 hover:scale-[1.01]">
        <div class="absolute -inset-1 bg-gradient-to-r from-primary/20 to-slate-200/30 rounded-[2rem] blur-md opacity-50 group-hover:opacity-100 transition duration-500"></div>
        <div class="glass-panel relative rounded-[2rem] flex flex-col items-start px-7 py-5 shadow-glass border border-white/60">
          <div class="flex items-center w-full mb-2">
            <span class="material-icons text-primary/80 mr-3 text-xl">mic_none</span>
            <span class="text-[10px] uppercase tracking-widest text-primary/60 font-semibold">Voice Input Active</span>
          </div>
          <input id="query-input" type="text" class="bg-transparent border-none w-full text-slate-800 placeholder-slate-400 focus:ring-0 text-lg tracking-wide font-light p-0 h-10" placeholder="Awaiting Command...">
          <div class="w-full h-0.5 bg-slate-100 mt-3 relative overflow-hidden rounded-full">
            <div class="absolute top-0 left-0 h-full w-1/3 bg-primary/50" style="animation:shimmer 2s infinite"></div>
          </div>
          <!-- Depth pills -->
          <div id="depth-selector" class="flex gap-2 mt-4 w-full">
            <button class="depth-btn flex-1 py-2 rounded-xl text-xs font-medium tracking-wide border border-slate-200 text-slate-400 transition-all hover:border-primary/30" data-depth="QUICK">Quick</button>
            <button class="depth-btn flex-1 py-2 rounded-xl text-xs font-medium tracking-wide border border-primary text-primary bg-primary/10 transition-all" data-depth="STANDARD">Standard</button>
            <button class="depth-btn flex-1 py-2 rounded-xl text-xs font-medium tracking-wide border border-slate-200 text-slate-400 transition-all hover:border-primary/30" data-depth="DEEP">Deep</button>
          </div>
          <!-- Business Context (optional, collapsible) -->
          <div id="business-context-section" class="hidden mt-3 w-full">
            <button id="bc-toggle" type="button" class="flex items-center gap-1 text-[10px] uppercase tracking-wider text-slate-400 hover:text-primary transition-colors">
              <span class="material-icons text-sm">tune</span>
              <span id="bc-toggle-label">Business Context (optional)</span>
            </button>
            <div id="bc-fields" class="hidden mt-2 space-y-2">
              <select id="bc-role" class="w-full text-xs rounded-lg border border-slate-200 bg-white/50 px-3 py-1.5 text-slate-600 focus:border-primary focus:ring-1 focus:ring-primary/30">
                <option value="">Role (optional)</option>
                <option value="Product Manager">Product Manager</option>
                <option value="Executive">Executive</option>
                <option value="Analyst">Analyst</option>
                <option value="Investor">Investor</option>
                <option value="Researcher">Researcher</option>
                <option value="Consultant">Consultant</option>
                <option value="Other">Other</option>
              </select>
              <select id="bc-decision" class="w-full text-xs rounded-lg border border-slate-200 bg-white/50 px-3 py-1.5 text-slate-600 focus:border-primary focus:ring-1 focus:ring-primary/30">
                <option value="">Decision Type (optional)</option>
                <option value="Build vs Buy">Build vs Buy</option>
                <option value="Market Entry">Market Entry</option>
                <option value="Investment">Investment</option>
                <option value="Strategy">Strategy</option>
                <option value="General">General</option>
              </select>
              <input id="bc-industry" type="text" placeholder="Industry (optional)" class="w-full text-xs rounded-lg border border-slate-200 bg-white/50 px-3 py-1.5 text-slate-600 placeholder-slate-300 focus:border-primary focus:ring-1 focus:ring-primary/30">
              <input id="bc-stakeholders" type="text" placeholder="Key stakeholders, comma-separated (optional)" class="w-full text-xs rounded-lg border border-slate-200 bg-white/50 px-3 py-1.5 text-slate-600 placeholder-slate-300 focus:border-primary focus:ring-1 focus:ring-primary/30">
            </div>
          </div>
        </div>
      </div>

      <!-- Neumorphic ACTIVATE button -->
      <div class="relative flex items-center justify-center">
        <div class="w-56 h-56 rounded-full bg-chrome-gradient shadow-neumorphic flex items-center justify-center relative">
          <div class="absolute inset-0 rounded-full border border-slate-200/50"></div>
          <div class="absolute inset-2 rounded-full border border-slate-100"></div>
          <button id="activate-btn" class="w-40 h-40 rounded-full bg-white shadow-inner-chrome flex items-center justify-center relative group active:scale-95 transition-transform duration-200 overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-tr from-slate-50 to-slate-100 z-0"></div>
            <div class="absolute w-full h-full opacity-0 group-hover:opacity-100 transition-opacity duration-700 bg-primary/5 blur-xl"></div>
            <div class="relative z-10 flex flex-col items-center justify-center">
              <div class="w-20 h-20 rounded-full bg-gradient-to-br from-primary to-cyan-300 shadow-glow flex items-center justify-center mb-2 group-hover:scale-105 transition-transform duration-300">
                <span class="material-icons text-white text-4xl drop-shadow-md">fingerprint</span>
              </div>
              <span class="text-[10px] font-semibold tracking-[0.25em] text-slate-400 group-hover:text-primary transition-colors duration-300 mt-2">ACTIVATE</span>
            </div>
            <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/40 to-transparent pointer-events-none rounded-t-full"></div>
          </button>
          <div class="absolute inset-0 pointer-events-none" style="animation:spin 8s linear infinite">
            <div class="absolute top-5 left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-primary/60 blur-[1px]"></div>
          </div>
        </div>
      </div>

      <!-- Agent KB status bar -->
      <div class="flex justify-between w-full px-6 text-[10px] text-slate-400 font-mono opacity-60">
        <span>MAYA: <span id="kb-maya" class="text-primary/80">--</span></span>
        <span>BARN: <span id="kb-barnaby" class="text-amber-400/80">--</span></span>
        <span>CONS: <span id="kb-consultant" class="text-violet-400/80">--</span></span>
      </div>
    </div>
  </div>

  <!-- ════════════ VALIDATION VIEW (DEEP only) ════════════ -->
  <div id="view-validate" class="view flex-1">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
      <p class="text-xs text-primary">Query Review</p>
    </header>
    <div class="flex-1 flex flex-col items-center justify-center gap-5 px-2">
      <div class="w-16 h-16 rounded-full bg-amber-50 flex items-center justify-center">
        <span class="material-icons text-amber-400 text-3xl">rate_review</span>
      </div>
      <div class="text-base font-semibold text-slate-700 text-center">Let's sharpen this query</div>
      <div id="validate-feedback" class="text-sm text-slate-500 text-center leading-relaxed px-2"></div>
      <div id="validate-suggested" class="glass-panel rounded-xl p-4 w-full shadow-glass border border-white/60 hidden">
        <div class="text-[10px] uppercase tracking-widest text-primary/60 font-semibold mb-2">Suggested query</div>
        <div id="validate-suggested-text" class="text-sm text-slate-700 font-medium"></div>
      </div>
      <button id="validate-use-suggested" onclick="App.useSuggested()"
              class="w-full py-3 rounded-xl bg-primary text-white text-center font-semibold text-sm hidden">
        Use Suggested Query
      </button>
      <button onclick="App.forceStart()"
              class="w-full py-3 rounded-xl border border-slate-200 text-slate-500 text-center font-medium text-sm hover:bg-slate-50">
        Start Anyway With Original
      </button>
      <button onclick="App.showView('home')"
              class="text-xs text-slate-400 hover:text-primary transition-colors">
        Back to edit
      </button>
    </div>
  </div>

  <!-- ════════════ PROGRESS VIEW ════════════ -->
  <div id="view-progress" class="view flex-1" style="overflow-y:auto">
    <header class="flex flex-col items-center mt-4 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
      <p class="text-xs text-primary">Researching...</p>
    </header>
    <div class="flex flex-col items-center gap-4 px-2 pb-4">
      <!-- Compact spinner + phase -->
      <div class="flex items-center gap-3 mt-3">
        <div class="relative w-10 h-10 flex-shrink-0">
          <div class="absolute inset-0 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 1.2s linear infinite"></div>
          <div class="absolute inset-1.5 border-2 border-slate-200 border-t-primary/50 rounded-full" style="animation:spin 1.8s linear infinite reverse"></div>
          <div class="absolute inset-0 flex items-center justify-center">
            <span class="material-icons text-primary text-sm">search</span>
          </div>
        </div>
        <div id="phase-text" class="text-sm text-slate-600 font-medium">Starting...</div>
      </div>

      <!-- Countdown + elapsed -->
      <div class="flex items-center gap-6 text-center">
        <div>
          <div class="text-[10px] uppercase tracking-wider text-slate-400 mb-0.5">Elapsed</div>
          <div id="elapsed" class="text-base font-mono font-medium text-slate-600 tabular-nums">0:00</div>
        </div>
        <div class="w-px h-6 bg-gradient-to-b from-transparent via-slate-200 to-transparent"></div>
        <div>
          <div class="text-[10px] uppercase tracking-wider text-slate-400 mb-0.5">Est. Remaining</div>
          <div id="countdown" class="text-base font-mono font-medium text-primary tabular-nums">--:--</div>
        </div>
      </div>

      <!-- Progress bar -->
      <div class="w-full px-2">
        <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
          <div id="progress-bar" class="h-full bg-gradient-to-r from-primary to-cyan-300 rounded-full transition-all duration-1000" style="width:0%"></div>
        </div>
        <div class="flex justify-between mt-0.5">
          <span id="progress-start" class="text-[10px] text-slate-400 font-mono">--:--</span>
          <span id="progress-pct" class="text-[10px] text-primary font-semibold">0%</span>
          <span id="progress-eta" class="text-[10px] text-slate-400 font-mono">--:--</span>
        </div>
      </div>

      <!-- Research Intelligence Dashboard -->
      <div id="research-stats" class="w-full hidden">
        <div class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold px-1 mb-2">Research Intelligence</div>
        <div class="stats-grid mb-3">
          <div class="stat-card">
            <div class="stat-value text-primary" id="stat-searches">0</div>
            <div class="stat-label">Searches</div>
          </div>
          <div class="stat-card">
            <div class="stat-value text-primary" id="stat-pages">0</div>
            <div class="stat-label">Pages Read</div>
          </div>
          <div class="stat-card">
            <div class="stat-value text-amber-500" id="stat-news">0</div>
            <div class="stat-label">News</div>
          </div>
          <div class="stat-card">
            <div class="stat-value text-violet-500" id="stat-ai">0</div>
            <div class="stat-label">AI Analyses</div>
          </div>
          <div class="stat-card">
            <div class="stat-value text-emerald-500" id="stat-sources">0</div>
            <div class="stat-label">URLs Fetched</div>
          </div>
          <div class="stat-card">
            <div class="stat-value text-rose-500" id="stat-grok">0</div>
            <div class="stat-label">Social Intel</div>
          </div>
        </div>
        <!-- Human Hours Hero -->
        <div class="human-hours-hero mb-3">
          <div class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold mb-1">Equivalent Human Effort</div>
          <div class="flex items-baseline justify-center gap-1">
            <span id="stat-human-hours" class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-violet-500">0</span>
            <span class="text-sm text-slate-400 font-medium">hours</span>
          </div>
          <div id="stat-hours-breakdown" class="text-[10px] text-slate-400 mt-1"></div>
        </div>
      </div>

      <!-- Parallel Research Cluster (visible when multiple studies run) -->
      <div id="parallel-cluster" class="w-full hidden">
        <div class="glass-panel rounded-xl p-3 shadow-glass border border-primary/10">
          <div class="flex items-center gap-2 mb-2">
            <span class="material-icons text-primary text-sm">device_hub</span>
            <span class="text-[10px] uppercase tracking-wider text-primary font-semibold">Parallel Research Cluster</span>
            <span id="cluster-count" class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded-full font-bold"></span>
          </div>
          <div id="cluster-nodes" class="flex flex-wrap gap-1.5"></div>
        </div>
      </div>

      <!-- Study plan tracker (DEEP only, populated by poll()) -->
      <div id="study-tracker" class="w-full space-y-1.5 hidden">
        <div class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold px-1">Research Plan</div>
        <div id="study-list" class="space-y-1"></div>
      </div>

      <!-- Pipeline steps tracker -->
      <div id="pipeline-steps" class="w-full hidden">
        <div class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold px-1 mb-1">Pipeline</div>
        <div id="step-list" class="space-y-1"></div>
      </div>

      <!-- Mid-research status card -->
      <div id="mid-check" class="glass-panel rounded-xl p-2.5 w-full shadow-glass border border-white/60">
        <div class="flex items-center gap-2">
          <span id="mid-check-icon" class="w-2 h-2 rounded-full bg-primary animate-pulse"></span>
          <span id="mid-check-text" class="text-[11px] text-slate-500">Pipeline running normally</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ════════════ RESULT VIEW ════════════ -->
  <div id="view-result" class="view flex-1">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
    </header>
    <div class="flex-1 flex flex-col items-center justify-center gap-4 px-2">
      <span class="material-icons text-6xl text-emerald-400">check_circle</span>
      <div class="text-lg font-semibold text-slate-700">Research Complete</div>
      <div id="result-query" class="text-sm text-slate-400 text-center"></div>
      <div class="w-full flex gap-2">
        <a id="result-link" href="#" target="_blank" rel="noopener"
           class="flex-1 py-3 rounded-xl bg-primary text-white text-center font-semibold text-sm tracking-wide hover:opacity-85 transition-opacity block">
          View Full Report
        </a>
        <button id="copy-url-btn" onclick="App.copyReportUrl()"
                class="px-4 py-3 rounded-xl border border-slate-200 text-slate-500 hover:bg-slate-50 hover:text-primary transition-colors flex items-center gap-1.5"
                title="Copy report URL (e.g. for NotebookLM)">
          <span class="material-icons text-lg">content_copy</span>
        </button>
      </div>

      <!-- NotebookLM Sources (collapsible) -->
      <div id="notebooklm-section" class="w-full hidden">
        <button onclick="document.getElementById('notebooklm-list').classList.toggle('hidden');this.querySelector('.expand-icon').textContent=document.getElementById('notebooklm-list').classList.contains('hidden')?'expand_more':'expand_less'"
                class="flex items-center gap-1.5 mx-auto text-[11px] text-slate-500 hover:text-primary transition-colors font-medium">
          <span class="material-icons text-sm">auto_stories</span>
          <span>NotebookLM Sources</span>
          <span class="material-icons text-sm expand-icon">expand_more</span>
        </button>
        <div id="notebooklm-list" class="hidden mt-2 space-y-1"></div>
      </div>

      <!-- Agent chat cards (primary action) -->
      <div class="w-full mt-4 space-y-2">
        <p class="text-[10px] uppercase tracking-widest text-slate-400 text-center mb-2">Chat about this research</p>
        <div id="result-agents" class="space-y-2"></div>
      </div>

      <!-- Reassign panel (hidden behind more_horiz) -->
      <div class="w-full mt-2">
        <button onclick="App.toggleReassign()"
                class="flex items-center gap-1 mx-auto text-[11px] text-slate-400 hover:text-primary transition-colors">
          <span class="material-icons text-sm">more_horiz</span>
          <span id="reassign-toggle-label">Reassign to specific agent</span>
        </button>
        <div id="reassign-panel" class="hidden mt-2 space-y-2">
          <div id="reassign-agents" class="space-y-2"></div>
          <div id="reassign-countdown" class="hidden text-center py-2">
            <div class="text-[11px] text-slate-400">RAG indexing in progress</div>
            <div id="reassign-timer" class="text-sm font-mono text-primary font-semibold">5:00</div>
            <div class="text-[10px] text-slate-400 mt-1">Chat will be available after indexing completes</div>
          </div>
        </div>
      </div>

      <button onclick="App.showView('home')"
              class="w-full py-3 rounded-xl border border-slate-200 text-slate-500 text-center font-medium text-sm hover:bg-slate-50 transition-colors mt-2">
        New Research
      </button>
    </div>
  </div>

  <!-- ════════════ ERROR VIEW ════════════ -->
  <div id="view-error" class="view flex-1">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
    </header>
    <div class="flex-1 flex flex-col items-center justify-center gap-4">
      <span class="material-icons text-6xl text-red-400">error</span>
      <div class="text-lg font-semibold text-slate-700">Research Failed</div>
      <div id="error-msg" class="text-sm text-slate-400 text-center px-4"></div>
      <button onclick="App.retry()" class="w-full py-3 rounded-xl bg-primary text-white text-center font-semibold text-sm">Retry</button>
      <button onclick="App.showView('home')" class="w-full py-3 rounded-xl border border-slate-200 text-slate-500 text-center font-medium text-sm">New Research</button>
    </div>
  </div>

  <!-- ════════════ CHAT VIEW ════════════ -->
  <div id="view-chat" class="view flex-1">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <div class="flex items-center space-x-2 text-[10px] tracking-[0.2em] font-medium uppercase text-slate-400">
        <span class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></span>
        <span>Agents Online</span>
      </div>
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Research Agents</h1>
    </header>
    <div id="chat-agents" class="mt-6 space-y-3"></div>
  </div>

  <!-- ════════════ GRAPH VIEW ════════════ -->
  <div id="view-graph" class="view flex-1" style="overflow-y:auto">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
      <p class="text-xs text-primary">Knowledge Graph</p>
    </header>
    <div id="graph-content" class="mt-4 px-2 pb-4">
      <div id="graph-stats" class="glass-panel rounded-xl p-4 shadow-glass border border-white/60 mb-3">
        <div class="flex items-center gap-2 mb-2">
          <span class="material-icons text-primary text-lg">hub</span>
          <span class="text-sm font-semibold text-slate-700">Graph Overview</span>
        </div>
        <div class="flex gap-4 text-center">
          <div><span id="graph-entities-count" class="text-lg font-bold text-primary">0</span><div class="text-[10px] text-slate-400">Entities</div></div>
          <div><span id="graph-rels-count" class="text-lg font-bold text-amber-500">0</span><div class="text-[10px] text-slate-400">Relations</div></div>
        </div>
      </div>
      <div class="mb-2">
        <input id="graph-search" type="text" placeholder="Search entities..."
               class="w-full px-3 py-2 rounded-lg bg-white/60 border border-slate-200 text-sm text-slate-700 placeholder-slate-400 focus:ring-1 focus:ring-primary"
               oninput="App.filterGraph(this.value)">
      </div>
      <div id="graph-entities-list" class="space-y-1.5"></div>
    </div>
  </div>

  <!-- ════════════ AMEND VIEW ════════════ -->
  <div id="view-amend" class="view flex-1">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
      <p class="text-xs text-amber-500">Amend Research</p>
    </header>
    <div class="flex-1 flex flex-col gap-4 px-2 mt-4">
      <div class="glass-panel rounded-xl p-4 shadow-glass border border-white/60">
        <div class="text-[10px] uppercase tracking-widest text-slate-400 font-semibold mb-1">Original Query</div>
        <div id="amend-original-query" class="text-sm text-slate-700 font-medium"></div>
      </div>
      <div>
        <label class="text-[10px] uppercase tracking-widest text-slate-400 font-semibold block mb-1">Additional Questions</label>
        <textarea id="amend-questions" rows="4"
                  class="w-full px-4 py-3 rounded-xl bg-white/60 border border-slate-200 text-sm text-slate-700 placeholder-slate-400 focus:ring-1 focus:ring-primary focus:border-primary"
                  placeholder="One question per line..."></textarea>
      </div>
      <div>
        <label class="text-[10px] uppercase tracking-widest text-slate-400 font-semibold block mb-1">New Perspective (optional)</label>
        <textarea id="amend-perspective" rows="2"
                  class="w-full px-4 py-3 rounded-xl bg-white/60 border border-slate-200 text-sm text-slate-700 placeholder-slate-400 focus:ring-1 focus:ring-primary focus:border-primary"
                  placeholder="e.g., Focus on environmental impact..."></textarea>
      </div>
      <button id="amend-submit-btn" onclick="App.submitAmendment()"
              class="w-full py-3 rounded-xl bg-gradient-to-r from-amber-400 to-amber-500 text-white text-center font-semibold text-sm hover:opacity-90 transition-opacity">
        Run Amendment
      </button>
      <button onclick="App.showView('archive')"
              class="w-full py-3 rounded-xl border border-slate-200 text-slate-500 text-center font-medium text-sm hover:bg-slate-50 transition-colors">
        Back to Archive
      </button>
    </div>
  </div>

  <!-- ════════════ WATCHES VIEW ════════════ -->
  <div id="view-watches" class="view flex-1" style="overflow-y:auto">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
      <p class="text-xs text-primary">Research Watches</p>
    </header>
    <div class="mt-4 px-2 pb-4">
      <!-- Create watch form -->
      <div class="glass-panel rounded-xl p-4 shadow-glass border border-white/60 mb-3">
        <div class="text-[10px] uppercase tracking-widest text-slate-400 font-semibold mb-2">New Watch</div>
        <input id="watch-query" type="text" placeholder="Topic to monitor..."
               class="w-full px-3 py-2 rounded-lg bg-white/60 border border-slate-200 text-sm text-slate-700 placeholder-slate-400 focus:ring-1 focus:ring-primary mb-2">
        <div class="flex gap-2">
          <select id="watch-interval" class="flex-1 px-3 py-2 rounded-lg bg-white/60 border border-slate-200 text-sm text-slate-700">
            <option value="6">Every 6 hours</option>
            <option value="12">Every 12 hours</option>
            <option value="24" selected>Daily</option>
            <option value="168">Weekly</option>
          </select>
          <button onclick="App.createWatch()"
                  class="px-4 py-2 rounded-lg bg-gradient-to-r from-primary to-cyan-400 text-white text-sm font-semibold hover:opacity-90 transition-opacity">
            Create
          </button>
        </div>
        <div class="mt-2 space-y-1">
          <input id="watch-email" type="email" placeholder="Notification email (optional)"
                 class="w-full px-3 py-1.5 rounded-lg bg-white/60 border border-slate-200 text-xs text-slate-600 placeholder-slate-300 focus:ring-1 focus:ring-primary">
          <input id="watch-webhook" type="url" placeholder="Webhook URL - Slack/Discord (optional)"
                 class="w-full px-3 py-1.5 rounded-lg bg-white/60 border border-slate-200 text-xs text-slate-600 placeholder-slate-300 focus:ring-1 focus:ring-primary">
        </div>
      </div>
      <div id="watches-list" class="space-y-2"></div>
    </div>
  </div>

  <!-- ════════════ ARCHIVE VIEW ════════════ -->
  <div id="view-archive" class="view flex-1">
    <header class="flex flex-col items-center mt-6 space-y-1 opacity-80">
      <h1 class="text-sm tracking-widest uppercase font-light text-slate-500">Lab Interface V2.0</h1>
      <p class="text-xs text-slate-400">Past Research</p>
    </header>
    <div id="archive-list" class="mt-4 space-y-2"></div>
  </div>


</main>

<!-- ════════════ BOTTOM NAV ════════════ -->
<nav id="bottom-nav" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50">
  <div class="glass-panel px-4 py-3 rounded-full flex items-center justify-between w-[340px] shadow-glass relative">
    <button class="nav-btn p-2 rounded-full hover:bg-slate-100 transition-colors group" data-view="archive">
      <span class="material-icons text-slate-400 group-hover:text-primary transition-colors text-xl">inventory_2</span>
    </button>
    <button class="nav-btn p-2 rounded-full hover:bg-slate-100 transition-colors group" data-view="graph">
      <span class="material-icons text-slate-400 group-hover:text-primary transition-colors text-xl">hub</span>
    </button>
    <!-- Center raised chat button -->
    <button class="nav-btn relative -top-6 p-4 rounded-full bg-gradient-to-b from-white to-slate-100 shadow-lg border border-slate-100 group hover:-translate-y-1 transition-transform duration-300" data-view="chat">
      <div class="absolute inset-0 bg-primary/20 blur-md rounded-full group-hover:bg-primary/40 transition-colors"></div>
      <div class="relative z-10 w-10 h-10 flex items-center justify-center">
        <div class="w-full flex items-center justify-center gap-[2px] h-4">
          <div class="w-[3px] bg-primary rounded-full" style="height:100%;animation:pulse-bar 1s ease-in-out infinite"></div>
          <div class="w-[3px] bg-primary rounded-full" style="height:80%;animation:pulse-bar 1.2s ease-in-out infinite 0.1s"></div>
          <div class="w-[3px] bg-primary rounded-full" style="height:60%;animation:pulse-bar 0.8s ease-in-out infinite 0.2s"></div>
          <div class="w-[3px] bg-primary rounded-full" style="height:90%;animation:pulse-bar 1.1s ease-in-out infinite 0.3s"></div>
        </div>
      </div>
    </button>
    <button class="nav-btn p-2 rounded-full hover:bg-slate-100 transition-colors group" data-view="watches">
      <span class="material-icons text-slate-400 group-hover:text-primary transition-colors text-xl">visibility</span>
    </button>
    <button class="nav-btn p-2 rounded-full hover:bg-slate-100 transition-colors group" data-view="home">
      <span class="material-icons text-slate-400 group-hover:text-primary transition-colors text-xl">home</span>
    </button>
  </div>
</nav>

<!-- ════════════ CALL OVERLAY ════════════ -->
<div id="call-overlay" class="widget-overlay">
  <div class="flex flex-col items-center justify-between h-full max-w-sm w-full py-16 px-6">
    <!-- Agent info -->
    <div class="flex flex-col items-center">
      <div class="w-24 h-24 rounded-full bg-white/80 shadow-neumorphic flex items-center justify-center mb-4 relative">
        <span id="call-agent-icon" class="material-icons text-4xl text-primary">bolt</span>
        <!-- Pulsing ring when connected -->
        <div id="call-pulse-ring" class="absolute inset-0 rounded-full border-2 border-primary/40 hidden" style="animation:spin 3s linear infinite"></div>
      </div>
      <div id="call-agent-name" class="text-xl font-semibold text-slate-700"></div>
      <div id="call-agent-subtitle" class="text-xs text-slate-400 mt-1"></div>
    </div>

    <!-- Status + timer -->
    <div class="flex flex-col items-center gap-3">
      <div id="call-status" class="flex items-center gap-2">
        <div id="call-status-dot" class="w-2.5 h-2.5 rounded-full bg-amber-400 animate-pulse"></div>
        <span id="call-status-text" class="text-sm text-slate-500">Connecting...</span>
      </div>
      <div id="call-timer" class="text-2xl font-mono font-light text-slate-400 tabular-nums hidden">0:00</div>
      <!-- Audio bars visualization -->
      <div id="call-audio-viz" class="flex items-end justify-center gap-[3px] h-8 hidden">
        <div class="w-[4px] bg-primary/60 rounded-full" style="height:40%;animation:pulse-bar 0.8s ease-in-out infinite"></div>
        <div class="w-[4px] bg-primary/60 rounded-full" style="height:70%;animation:pulse-bar 1.0s ease-in-out infinite 0.1s"></div>
        <div class="w-[4px] bg-primary/60 rounded-full" style="height:100%;animation:pulse-bar 0.7s ease-in-out infinite 0.2s"></div>
        <div class="w-[4px] bg-primary/60 rounded-full" style="height:60%;animation:pulse-bar 0.9s ease-in-out infinite 0.15s"></div>
        <div class="w-[4px] bg-primary/60 rounded-full" style="height:80%;animation:pulse-bar 1.1s ease-in-out infinite 0.25s"></div>
      </div>
      <!-- Error message -->
      <div id="call-error" class="text-sm text-red-400 text-center hidden"></div>
    </div>

    <!-- End call button -->
    <button id="call-end-btn" onclick="App.endCall()"
            class="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center shadow-lg hover:bg-red-600 active:scale-95 transition-all">
      <span class="material-icons text-white text-3xl">call_end</span>
    </button>
  </div>
</div>

<script>
const App = (function() {
  /* ── State ── */
  let currentView = 'home';
  let selectedDepth = 'STANDARD';
  let activeJobs = {};       // {jobId: {query, depth, startTime, estimatedSeconds, phase, status, phaseTimings, researchStats}}
  let viewingJobId = null;   // Which job is shown in progress view
  let pollTimer = null;
  let elapsedTimer = null;
  let lastQuery = '';
  let lastDocId = '';
  let lastDocName = '';
  let agentsData = [];
  let historicalTimings = null;
  let pipelineRendered = false;
  let lastRenderedStats = {};

  const PHASE_ORDER = ['analysis', 'planning', 'studies', 'synthesis', 'claim_validation', 'evaluation', 'refinement', 'verification', 'strategic_analysis', 'qa', 'upload'];
  const PIPELINE_STEPS = [
    {id:'analysis', label:'Analyzing query', icon:'search'},
    {id:'planning', label:'Planning studies', icon:'psychology'},
    {id:'studies', label:'Researching studies', icon:'science'},
    {id:'synthesis', label:'Master synthesis', icon:'auto_awesome'},
    {id:'claim_validation', label:'Validating claims', icon:'gavel'},
    {id:'evaluation', label:'Quality evaluation', icon:'fact_check'},
    {id:'refinement', label:'Refining synthesis', icon:'refresh'},
    {id:'verification', label:'Verifying facts', icon:'verified'},
    {id:'strategic_analysis', label:'Strategic frameworks', icon:'analytics'},
    {id:'qa', label:'Anticipated Q&A', icon:'forum'},
  ];

  /* ── Helpers ── */
  function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }
  function escAttr(s) { return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function fmtTime(secs) {
    if (secs < 0) secs = 0;
    const m = Math.floor(secs / 60);
    const s = Math.floor(secs % 60);
    return m + ':' + String(s).padStart(2, '0');
  }
  function hasActiveJobs() { return Object.keys(activeJobs).length > 0; }

  /* ── View Navigation ── */
  function showView(name) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    const el = document.getElementById('view-' + name);
    if (el) el.classList.add('active');
    currentView = name;

    document.querySelectorAll('.nav-btn').forEach(b => {
      const icon = b.querySelector('.material-icons');
      if (icon) { icon.classList.remove('text-primary'); icon.classList.add('text-slate-400'); }
    });
    const navBtn = document.querySelector(`.nav-btn[data-view="${name}"]`);
    if (navBtn) {
      const icon = navBtn.querySelector('.material-icons');
      if (icon) { icon.classList.remove('text-slate-400'); icon.classList.add('text-primary'); }
    }

    if (name === 'archive') loadArchive();
    if (name === 'chat') loadChatAgents();
    if (name === 'graph') loadGraph();
    if (name === 'watches') loadWatches();
    if (name === 'home') { loadStats(); renderBanners(); }
  }

  /* ── Bottom nav ── */
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => showView(btn.dataset.view));
  });

  /* ── Depth selector ── */
  document.querySelectorAll('.depth-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.depth-btn').forEach(b => {
        b.classList.remove('border-primary','text-primary','bg-primary/10');
        b.classList.add('border-slate-200','text-slate-400');
      });
      btn.classList.remove('border-slate-200','text-slate-400');
      btn.classList.add('border-primary','text-primary','bg-primary/10');
      selectedDepth = btn.dataset.depth;
      // Show/hide business context for STANDARD and DEEP
      const bcSection = document.getElementById('business-context-section');
      if (selectedDepth === 'QUICK') {
        bcSection.classList.add('hidden');
      } else {
        bcSection.classList.remove('hidden');
      }
    });
  });

  // Business context toggle
  document.getElementById('bc-toggle').addEventListener('click', () => {
    const fields = document.getElementById('bc-fields');
    fields.classList.toggle('hidden');
  });

  function getBusinessContext() {
    const role = document.getElementById('bc-role').value;
    const decision = document.getElementById('bc-decision').value;
    const industry = document.getElementById('bc-industry').value.trim();
    const stakeholders = document.getElementById('bc-stakeholders').value.trim();
    if (!role && !decision && !industry && !stakeholders) return null;
    return { user_role: role, decision_type: decision, industry, stakeholders };
  }

  /* ── ACTIVATE ── */
  const activateBtn = document.getElementById('activate-btn');
  const queryInput = document.getElementById('query-input');
  let suggestedQuery = '';

  activateBtn.addEventListener('click', async () => {
    const query = queryInput.value.trim();
    if (!query) { queryInput.focus(); return; }

    activateBtn.disabled = true;
    lastQuery = query;

    try {
      if (selectedDepth === 'DEEP') {
        const valRes = await fetch('/api/research/validate', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ query, depth: selectedDepth })
        });
        const val = await valRes.json();
        if (!val.clear) {
          document.getElementById('validate-feedback').textContent = val.feedback || 'Your query could be more specific.';
          const sugBox = document.getElementById('validate-suggested');
          const sugBtn = document.getElementById('validate-use-suggested');
          if (val.suggested_query) {
            suggestedQuery = val.suggested_query;
            document.getElementById('validate-suggested-text').textContent = val.suggested_query;
            sugBox.classList.remove('hidden');
            sugBtn.classList.remove('hidden');
          } else {
            sugBox.classList.add('hidden');
            sugBtn.classList.add('hidden');
          }
          showView('validate');
          activateBtn.disabled = false;
          return;
        }
      }
      await launchResearch(query);
    } catch(e) {
      alert('Failed to start: ' + e.message);
    } finally {
      activateBtn.disabled = false;
    }
  });

  async function launchResearch(query) {
    const payload = { query, depth: selectedDepth };
    const bc = getBusinessContext();
    if (bc) payload.business_context = bc;
    const res = await fetch('/api/research', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Request failed');

    const jobId = data.job_id;
    const estSecs = data.estimated_seconds || 300;
    const now = Date.now();

    // Add to active jobs
    activeJobs[jobId] = {
      query, depth: selectedDepth, startTime: now,
      estimatedSeconds: estSecs, phase: 'Starting...', status: 'running',
      phaseTimings: {}, researchStats: {}, studyProgress: [], currentStep: '',
    };
    viewingJobId = jobId;
    persistActiveJobs();

    // Reset and prepare progress view
    resetProgressView(now, estSecs);

    if (selectedDepth === 'DEEP') fetchTimingEstimates();

    // Start polling if not already running
    ensurePolling();

    showView('progress');
    queryInput.value = '';
  }

  function resetProgressView(startMs, estSecs) {
    pipelineRendered = false;
    lastRenderedStats = {};
    document.getElementById('study-tracker').classList.add('hidden');
    document.getElementById('pipeline-steps').classList.add('hidden');
    document.getElementById('research-stats').classList.add('hidden');
    document.getElementById('parallel-cluster').classList.add('hidden');
    document.getElementById('study-list').innerHTML = '';
    document.getElementById('step-list').innerHTML = '';
    document.getElementById('phase-text').textContent = 'Starting...';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-pct').textContent = '0%';
    const start = new Date(startMs);
    const eta = new Date(startMs + estSecs * 1000);
    document.getElementById('progress-start').textContent = start.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
    document.getElementById('progress-eta').textContent = eta.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
  }

  function useSuggested() {
    if (suggestedQuery) { queryInput.value = suggestedQuery; lastQuery = suggestedQuery; }
    forceStart();
  }
  async function forceStart() {
    activateBtn.disabled = true;
    try { await launchResearch(lastQuery); }
    catch(e) { alert('Failed to start: ' + e.message); showView('home'); }
    finally { activateBtn.disabled = false; }
  }
  queryInput.addEventListener('keydown', e => { if (e.key === 'Enter') activateBtn.click(); });

  /* ── localStorage persistence for active jobs ── */
  function persistActiveJobs() {
    const toSave = {};
    for (const [jid, j] of Object.entries(activeJobs)) {
      toSave[jid] = { query: j.query, depth: j.depth, startTime: j.startTime, estimatedSeconds: j.estimatedSeconds };
    }
    localStorage.setItem('activeJobs', JSON.stringify(toSave));
  }
  function removeActiveJob(jobId) {
    delete activeJobs[jobId];
    if (viewingJobId === jobId) viewingJobId = Object.keys(activeJobs)[0] || null;
    persistActiveJobs();
    renderBanners();
    if (!hasActiveJobs()) stopPolling();
  }

  /* ── Polling — shared timer for ALL active jobs ── */
  function ensurePolling() {
    if (pollTimer) return;
    updateTimers();
    elapsedTimer = setInterval(updateTimers, 1000);
    pollAllJobs();
    pollTimer = setInterval(pollAllJobs, 3000);
  }
  function stopPolling() {
    clearInterval(pollTimer); clearInterval(elapsedTimer);
    pollTimer = null; elapsedTimer = null;
  }

  async function fetchTimingEstimates() {
    try {
      const res = await fetch('/api/timing-estimates');
      if (res.ok) {
        historicalTimings = await res.json();
        if (historicalTimings.total_average > 0 && viewingJobId && activeJobs[viewingJobId]) {
          activeJobs[viewingJobId].estimatedSeconds = historicalTimings.total_average;
        }
      }
    } catch(e) { /* use default */ }
  }

  function computeSmartEstimate(job) {
    if (!historicalTimings || !historicalTimings.phase_averages || historicalTimings.sample_count === 0) {
      const elapsed = (Date.now() - job.startTime) / 1000;
      return Math.max(0, job.estimatedSeconds - elapsed);
    }
    const avgs = historicalTimings.phase_averages;
    const pt = job.phaseTimings || {};
    let remaining = 0, foundCurrent = false;
    for (const phase of PHASE_ORDER) {
      const avg = avgs[phase] || 0;
      const live = pt[phase];
      if (live && live.duration) continue;
      else if (live && live.start && !live.end) {
        foundCurrent = true;
        const spent = Date.now() / 1000 - live.start;
        remaining += Math.max(0, avg - spent);
      } else if (foundCurrent) {
        remaining += avg;
      }
    }
    return remaining;
  }

  function updateTimers() {
    if (!viewingJobId || !activeJobs[viewingJobId]) return;
    const job = activeJobs[viewingJobId];
    const elapsed = (Date.now() - job.startTime) / 1000;
    const remaining = computeSmartEstimate(job);
    const totalEst = elapsed + remaining;
    const pct = totalEst > 0 ? Math.min(99, (elapsed / totalEst) * 100) : 0;

    document.getElementById('elapsed').textContent = fmtTime(elapsed);
    document.getElementById('countdown').textContent = remaining > 0 ? fmtTime(remaining) : 'Any moment...';
    document.getElementById('progress-bar').style.width = pct.toFixed(1) + '%';
    document.getElementById('progress-pct').textContent = Math.floor(pct) + '%';
  }

  /* ── Poll all active jobs ── */
  let lastPhase = '';

  async function pollAllJobs() {
    const jobIds = Object.keys(activeJobs);
    if (!jobIds.length) return;

    for (const jobId of jobIds) {
      try {
        const res = await fetch('/api/status/' + jobId);
        if (!res.ok) {
          if (res.status === 404) {
            removeActiveJob(jobId);
            if (currentView === 'progress' && !viewingJobId) {
              document.getElementById('error-msg').textContent = 'Research session was lost (server restarted). Please start a new one.';
              showView('error');
            }
          }
          continue;
        }
        const data = await res.json();
        const job = activeJobs[jobId];
        if (!job) continue;

        job.phase = data.phase || 'Working...';
        job.status = data.status;
        if (data.phase_timings) job.phaseTimings = data.phase_timings;
        if (data.research_stats) job.researchStats = data.research_stats;
        if (data.study_progress) job.studyProgress = data.study_progress;
        if (data.current_step) job.currentStep = data.current_step;

        // Update progress view if this is the viewing job
        if (jobId === viewingJobId && currentView === 'progress') {
          document.getElementById('phase-text').textContent = job.phase;

          if (data.study_progress && data.study_progress.length) {
            renderStudyTracker(data.study_progress);
            renderParallelCluster(data.study_progress);
          }
          if (data.current_step) renderPipelineSteps(data.current_step);
          if (data.research_stats) renderResearchStats(data.research_stats, job.depth);

          // Mid-check
          const midIcon = document.getElementById('mid-check-icon');
          const midText = document.getElementById('mid-check-text');
          if (data.status === 'running') {
            if (job.phase !== lastPhase && lastPhase) {
              midText.textContent = 'Phase update: ' + job.phase;
            } else {
              midText.textContent = 'Pipeline running normally';
            }
            midIcon.className = 'w-2 h-2 rounded-full bg-primary animate-pulse';
          }
          lastPhase = job.phase;
        }

        // Handle completion / failure
        if (data.status === 'completed') {
          if (jobId === viewingJobId && currentView === 'progress') {
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('progress-pct').textContent = '100%';
            document.getElementById('countdown').textContent = '0:00';
            lastDocId = data.elevenlabs_doc_id || '';
            lastDocName = 'Research: ' + (data.query||'').substring(0,60);
            document.getElementById('result-query').textContent = data.query;
            const link = document.getElementById('result-link');
            if (data.result_url) { link.href = data.result_url; link.style.display = 'block'; }
            else { link.style.display = 'none'; }
            renderResultAgents(true);
            renderNotebookLmSources(data.notebooklm_urls || []);
            setTimeout(() => showView('result'), 600);
          }
          removeActiveJob(jobId);
        } else if (data.status === 'failed') {
          if (jobId === viewingJobId && currentView === 'progress') {
            document.getElementById('error-msg').textContent = data.error || 'An unknown error occurred';
            setTimeout(() => showView('error'), 1500);
          }
          removeActiveJob(jobId);
        }
      } catch(e) { /* keep polling */ }
    }

    // Update banners on home
    if (currentView === 'home') renderBanners();
  }

  /* ── Banners (multiple active jobs on home) ── */
  function renderBanners() {
    const container = document.getElementById('active-jobs-banners');
    if (!container) return;
    const entries = Object.entries(activeJobs).filter(([,j]) => j.status === 'running');
    if (!entries.length) { container.innerHTML = ''; return; }

    container.innerHTML = entries.map(([jid, j]) => {
      const elapsed = (Date.now() - j.startTime) / 1000;
      const remaining = computeSmartEstimate(j);
      const stats = j.researchStats || {};
      const pages = (stats.pages_read || 0) + (stats.news_articles || 0);
      const searches = (stats.web_searches || 0) + (stats.news_searches || 0) + (stats.grok_queries || 0);
      const statsText = searches > 0 ? ` · ${searches} searches · ${pages} pages` : '';
      return `<div class="glass-panel rounded-xl p-3 shadow-glass border border-primary/20 flex items-center gap-3 cursor-pointer"
                   onclick="App.viewJob('${esc(jid)}')">
        <div class="relative w-8 h-8 flex-shrink-0">
          <div class="absolute inset-0 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 1.2s linear infinite"></div>
        </div>
        <div class="flex-1 min-w-0">
          <div class="text-xs font-semibold text-slate-700 truncate">${esc(j.query)}</div>
          <div class="text-[10px] text-slate-400">${esc(j.phase)}${statsText} · <span class="text-primary font-mono">${fmtTime(remaining)}</span> remaining</div>
        </div>
        <span class="material-icons text-primary text-lg">arrow_forward</span>
      </div>`;
    }).join('');
  }

  function viewJob(jobId) {
    if (!activeJobs[jobId]) return;
    viewingJobId = jobId;
    const job = activeJobs[jobId];
    resetProgressView(job.startTime, job.estimatedSeconds);
    showView('progress');
  }

  /* ── Research Stats Display ── */
  function renderResearchStats(stats, depth) {
    if (!stats || typeof stats !== 'object') return;
    const container = document.getElementById('research-stats');
    const totalActivity = (stats.web_searches||0) + (stats.pages_read||0) + (stats.news_articles||0) + (stats.grok_queries||0) + (stats.reasoning_calls||0);
    if (totalActivity === 0) return;

    container.classList.remove('hidden');

    // Animate counter changes
    function setCounter(id, val) {
      const el = document.getElementById(id);
      if (!el) return;
      const old = parseInt(el.textContent) || 0;
      if (val !== old) {
        el.textContent = val;
        el.classList.remove('stat-flash');
        void el.offsetWidth; // trigger reflow
        el.classList.add('stat-flash');
      }
    }

    const searches = (stats.web_searches||0) + (stats.news_searches||0) + (stats.grok_queries||0);
    setCounter('stat-searches', searches);
    setCounter('stat-pages', stats.pages_read || 0);
    setCounter('stat-news', stats.news_articles || 0);
    setCounter('stat-ai', stats.reasoning_calls || 0);
    setCounter('stat-sources', stats.urls_fetched || 0);
    setCounter('stat-grok', stats.grok_queries || 0);

    // Human hours
    const hh = stats.human_hours;
    if (hh && hh.total_hours > 0) {
      document.getElementById('stat-human-hours').textContent = hh.total_hours.toFixed(1);
      const parts = [];
      if (hh.searching_min > 0) parts.push(`${Math.round(hh.searching_min/60*10)/10}h searching`);
      if (hh.reading_min > 0) parts.push(`${Math.round(hh.reading_min/60*10)/10}h reading`);
      if (hh.analyzing_min > 0) parts.push(`${Math.round(hh.analyzing_min/60*10)/10}h analyzing`);
      if (hh.writing_min > 0) parts.push(`${Math.round(hh.writing_min/60*10)/10}h writing`);
      document.getElementById('stat-hours-breakdown').textContent = parts.join(' · ');
    } else {
      // Compute approximate human hours from raw stats
      const searchMin = searches * 8;
      const readMin = (stats.pages_read||0) * 5 + (stats.news_articles||0) * 3;
      const analyzeMin = (stats.reasoning_calls||0) * 15;
      const total = searchMin + readMin + analyzeMin;
      if (total > 0) {
        document.getElementById('stat-human-hours').textContent = (total / 60).toFixed(1);
        document.getElementById('stat-hours-breakdown').textContent = 'Searching + reading + analysis equivalent';
      }
    }
  }

  /* ── Parallel Cluster Visualization ── */
  function renderParallelCluster(studyProgress) {
    if (!studyProgress || !studyProgress.length) return;
    const running = studyProgress.filter(s => s.status === 'running');
    const container = document.getElementById('parallel-cluster');
    const nodesEl = document.getElementById('cluster-nodes');
    const countEl = document.getElementById('cluster-count');

    if (running.length < 2) {
      container.classList.add('hidden');
      return;
    }

    container.classList.remove('hidden');
    countEl.textContent = running.length + ' parallel';

    nodesEl.innerHTML = studyProgress.map((s, i) => {
      let cls = 'pending';
      if (s.status === 'running') cls = 'active';
      else if (s.status === 'done') cls = 'done';
      else if (s.status === 'failed') cls = 'failed';
      const label = (s.title || 'Study '+(i+1)).substring(0, 30);
      const icon = cls === 'active' ? '<div class="inline-block w-3 h-3 border-2 border-slate-200 border-t-primary rounded-full mr-1 align-middle" style="animation:spin 0.8s linear infinite"></div>' :
                   cls === 'done' ? '<span class="material-icons text-xs align-middle mr-0.5">check</span>' :
                   cls === 'failed' ? '<span class="material-icons text-xs align-middle mr-0.5">close</span>' : '';
      return `<span class="cluster-node ${cls}">${icon}${esc(label)}</span>`;
    }).join('');
  }

  /* ── Study Tracker ── */
  function renderStudyTracker(studyProgress) {
    const tracker = document.getElementById('study-tracker');
    const list = document.getElementById('study-list');
    if (!studyProgress || !studyProgress.length) { tracker.classList.add('hidden'); return; }
    tracker.classList.remove('hidden');
    list.innerHTML = studyProgress.map((s, i) => {
      let statusIcon, textClass;
      if (s.status === 'done') {
        statusIcon = '<span class="material-icons text-emerald-500 text-sm">check_circle</span>';
        textClass = 'text-emerald-700';
      } else if (s.status === 'running') {
        statusIcon = '<div class="w-4 h-4 border-2 border-slate-200 border-t-primary rounded-full flex-shrink-0" style="animation:spin 1s linear infinite"></div>';
        textClass = 'text-slate-700 font-medium';
      } else if (s.status === 'failed') {
        statusIcon = '<span class="material-icons text-red-400 text-sm">error</span>';
        textClass = 'text-red-500';
      } else {
        statusIcon = '<span class="material-icons text-slate-300 text-sm">radio_button_unchecked</span>';
        textClass = 'text-slate-400';
      }
      return `<div class="flex items-center gap-2 px-1">${statusIcon}<span class="text-xs ${textClass} truncate">${s.title || 'Study '+(i+1)}</span></div>`;
    }).join('');
  }

  function normalizePipelineStep(step) {
    if (!step) return step;
    if (step.startsWith('study_')) return 'studies';
    if (step.startsWith('gap_study_')) return 'refinement';
    return step;
  }

  function renderPipelineSteps(currentStep) {
    const container = document.getElementById('pipeline-steps');
    const list = document.getElementById('step-list');
    const normalized = normalizePipelineStep(currentStep);
    if (!normalized && !pipelineRendered) return;
    container.classList.remove('hidden');
    pipelineRendered = true;
    const stepIdx = PIPELINE_STEPS.findIndex(s => s.id === normalized);
    list.innerHTML = PIPELINE_STEPS.map((s, i) => {
      let icon, textClass;
      if (i < stepIdx) { icon = `<span class="material-icons text-emerald-500 text-sm">check_circle</span>`; textClass = 'text-emerald-700'; }
      else if (i === stepIdx) { icon = `<div class="w-4 h-4 border-2 border-slate-200 border-t-primary rounded-full flex-shrink-0" style="animation:spin 1s linear infinite"></div>`; textClass = 'text-slate-700 font-medium'; }
      else { icon = `<span class="material-icons text-slate-300 text-sm">radio_button_unchecked</span>`; textClass = 'text-slate-400'; }
      return `<div class="flex items-center gap-2 px-1">${icon}<span class="material-icons ${textClass} text-sm">${s.icon}</span><span class="text-xs ${textClass}">${s.label}</span></div>`;
    }).join('');
  }

  /* ── Shared agent card renderer ── */
  function renderAgentCard(a, mode) {
    const docs = a.kb_docs || [];
    const kbHtml = docs.length
      ? docs.slice(0, 3).map(d => {
          const label = (d.name || d.id || '').replace(/^Research:\s*/i, '').substring(0, 50);
          return `<span class="kb-tag">${esc(label)}</span>`;
        }).join('') + (docs.length > 3 ? `<span class="kb-tag">+${docs.length - 3} more</span>` : '')
      : '<span class="text-[10px] text-slate-300 italic">No research loaded</span>';

    if (mode === 'chat') {
      return `<div class="agent-card agent-${esc(a.color)}" onclick="App.startCall('${esc(a.agent_id)}','${esc(a.name)}')">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 rounded-full bg-white/80 shadow-inner-chrome flex items-center justify-center flex-shrink-0">
            <span class="material-icons agent-icon text-xl">${esc(a.icon)}</span>
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <span class="font-semibold text-slate-700 text-sm">${esc(a.name)}</span>
              <span class="agent-dot"></span>
            </div>
            <div class="text-[11px] text-slate-400">${esc(a.subtitle)}</div>
          </div>
          <span class="material-icons text-slate-300 text-lg">chat</span>
        </div>
        <div class="flex flex-wrap gap-1 ml-[52px]">${kbHtml}</div>
      </div>`;
    }

    const cardId = 'agent-card-' + a.slug;
    return `<div id="${cardId}" class="agent-card agent-${esc(a.color)}">
      <div class="flex items-center gap-3 mb-2">
        <div class="w-10 h-10 rounded-full bg-white/80 shadow-inner-chrome flex items-center justify-center flex-shrink-0">
          <span class="material-icons agent-icon text-xl">${esc(a.icon)}</span>
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2">
            <span class="font-semibold text-slate-700 text-sm">${esc(a.name)}</span>
            <span class="agent-dot"></span>
          </div>
          <div class="text-[11px] text-slate-400">${esc(a.subtitle)}</div>
        </div>
      </div>
      <div class="flex flex-wrap gap-1 ml-[52px] mb-2">${kbHtml}</div>
      <div id="${cardId}-actions" class="flex gap-2 ml-[52px]">
        <button onclick="App.assignToAgent('${esc(a.slug)}','${esc(a.agent_id)}','${esc(a.name)}')"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-semibold text-white bg-gradient-to-r from-primary to-cyan-400 hover:opacity-90 transition-opacity">
          <span class="material-icons text-sm">add_circle</span> Assign Research
        </button>
        <button onclick="App.startCall('${esc(a.agent_id)}','${esc(a.name)}')"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-medium text-slate-500 border border-slate-200 hover:bg-slate-50 transition-colors">
          <span class="material-icons text-sm">chat</span> Chat
        </button>
      </div>
    </div>`;
  }

  /* ── Result: agent cards (chat mode primary) ── */
  async function renderResultAgents(fresh) {
    const container = document.getElementById('result-agents');
    const reassignContainer = document.getElementById('reassign-agents');
    try {
      const url = fresh ? '/api/agents?fresh=1' : '/api/agents';
      const res = await fetch(url);
      const data = await res.json();
      agentsData = data.agents || [];
      // Primary: chat cards
      container.innerHTML = agentsData.map(a => renderAgentCard(a, 'chat')).join('');
      // Secondary: attach cards in reassign panel
      if (reassignContainer && lastDocId) {
        reassignContainer.innerHTML = agentsData.map(a => renderAgentCard(a, 'attach')).join('');
      }
    } catch(e) {
      container.innerHTML = '<p class="text-xs text-red-400 text-center">Failed to load agents</p>';
    }
  }

  function toggleReassign() {
    const panel = document.getElementById('reassign-panel');
    const label = document.getElementById('reassign-toggle-label');
    if (panel.classList.contains('hidden')) {
      panel.classList.remove('hidden');
      label.textContent = 'Hide reassign';
    } else {
      panel.classList.add('hidden');
      label.textContent = 'Reassign to specific agent';
    }
  }

  /* ── Assign research to agent ── */
  async function assignToAgent(slug, agentId, agentName) {
    if (!agentId) { alert('Agent not configured'); return; }
    const cardId = 'agent-card-' + slug;
    const actionsEl = document.getElementById(cardId + '-actions');
    if (!actionsEl) return;

    if (!lastDocId) {
      actionsEl.innerHTML = `<div class="flex items-center gap-2 text-[11px] text-amber-500"><span class="material-icons text-sm">warning</span> No research document available</div>`;
      return;
    }

    actionsEl.innerHTML = `<div class="flex items-center gap-2 text-[11px] text-slate-400">
      <div class="w-4 h-4 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 0.8s linear infinite"></div>
      Assigning to ${esc(agentName)}...
    </div>`;

    try {
      const res = await fetch(`/api/agents/${slug}/attach`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ doc_id: lastDocId, doc_name: lastDocName })
      });
      const data = await res.json();
      if (res.ok) {
        actionsEl.innerHTML = `<div class="flex items-center gap-2 text-[11px] text-emerald-600 font-semibold">
          <span class="material-icons text-sm">check_circle</span> Assigned to ${esc(agentName)}!
        </div>`;
        // Start 5-min RAG countdown
        startReassignCountdown(agentId, agentName);
      } else {
        actionsEl.innerHTML = `<div class="flex items-center gap-2 text-[11px] text-red-500"><span class="material-icons text-sm">error</span> ${esc(data.error||'Failed')}</div>
        <button onclick="App.assignToAgent('${esc(slug)}','${esc(agentId)}','${esc(agentName)}')" class="text-[11px] text-slate-500 underline mt-1">Retry</button>`;
      }
    } catch(e) {
      actionsEl.innerHTML = `<div class="flex items-center gap-2 text-[11px] text-red-500"><span class="material-icons text-sm">error</span> Connection failed</div>
      <button onclick="App.assignToAgent('${esc(slug)}','${esc(agentId)}','${esc(agentName)}')" class="text-[11px] text-slate-500 underline mt-1">Retry</button>`;
    }
  }

  /* ── Reassign RAG countdown ── */
  let reassignTimer = null;

  function startReassignCountdown(agentId, agentName) {
    const endTime = Date.now() + 5 * 60 * 1000; // 5 minutes
    localStorage.setItem('reassignCountdown', JSON.stringify({ endTime, agentId, agentName }));
    const countdownEl = document.getElementById('reassign-countdown');
    const timerEl = document.getElementById('reassign-timer');
    if (countdownEl) countdownEl.classList.remove('hidden');

    // Disable chat cards during countdown
    document.querySelectorAll('#result-agents .agent-card').forEach(c => {
      c.style.opacity = '0.5';
      c.style.pointerEvents = 'none';
    });

    clearInterval(reassignTimer);
    reassignTimer = setInterval(() => {
      const remaining = Math.max(0, endTime - Date.now());
      if (remaining <= 0) {
        clearInterval(reassignTimer);
        reassignTimer = null;
        localStorage.removeItem('reassignCountdown');
        if (countdownEl) countdownEl.classList.add('hidden');
        // Re-enable chat cards
        document.querySelectorAll('#result-agents .agent-card').forEach(c => {
          c.style.opacity = '1';
          c.style.pointerEvents = 'auto';
        });
        return;
      }
      const m = Math.floor(remaining / 60000);
      const s = Math.floor((remaining % 60000) / 1000);
      if (timerEl) timerEl.textContent = m + ':' + String(s).padStart(2, '0');
    }, 1000);
  }

  // Restore countdown on page load
  function restoreReassignCountdown() {
    const saved = localStorage.getItem('reassignCountdown');
    if (!saved) return;
    try {
      const { endTime, agentId, agentName } = JSON.parse(saved);
      if (endTime > Date.now()) {
        startReassignCountdown(agentId, agentName);
      } else {
        localStorage.removeItem('reassignCountdown');
      }
    } catch(e) { localStorage.removeItem('reassignCountdown'); }
  }

  /* ── Chat view ── */
  async function loadChatAgents() {
    const container = document.getElementById('chat-agents');
    container.innerHTML = '<div class="flex justify-center py-8"><div class="w-6 h-6 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 0.8s linear infinite"></div></div>';
    try {
      const res = await fetch('/api/agents');
      const data = await res.json();
      agentsData = data.agents || [];
      container.innerHTML = agentsData.map(a => renderAgentCard(a, 'chat')).join('');
    } catch(e) {
      container.innerHTML = '<p class="text-sm text-red-400 text-center py-8">Failed to load agents</p>';
    }
  }

  /* ── Voice Call (ElevenLabs SDK) ── */
  let activeConversation = null;
  let callTimerInterval = null;
  let callStartTime = null;

  async function startCall(agentId, agentName) {
    if (!agentId) { alert('Agent not configured'); return; }
    const agent = agentsData.find(a => a.agent_id === agentId) || {};
    const iconEl = document.getElementById('call-agent-icon');
    const colorMap = { cyan: '#0dccf2', amber: '#f59e0b', violet: '#8b5cf6' };
    iconEl.textContent = agent.icon || 'mic';
    iconEl.style.color = colorMap[agent.color] || '#0dccf2';
    document.getElementById('call-agent-name').textContent = agentName || 'Agent';
    document.getElementById('call-agent-subtitle').textContent = agent.subtitle || '';
    document.getElementById('call-status-dot').className = 'w-2.5 h-2.5 rounded-full bg-amber-400 animate-pulse';
    document.getElementById('call-status-text').textContent = 'Connecting...';
    document.getElementById('call-timer').classList.add('hidden');
    document.getElementById('call-audio-viz').classList.add('hidden');
    document.getElementById('call-pulse-ring').classList.add('hidden');
    document.getElementById('call-error').classList.add('hidden');
    document.getElementById('call-overlay').classList.add('active');

    try {
      const { Conversation } = await import('https://cdn.jsdelivr.net/npm/@elevenlabs/client@0.14.0/+esm');
      activeConversation = await Conversation.startSession({
        agentId,
        onConnect: () => {
          document.getElementById('call-status-dot').className = 'w-2.5 h-2.5 rounded-full bg-emerald-400';
          document.getElementById('call-status-text').textContent = 'Connected';
          document.getElementById('call-timer').classList.remove('hidden');
          document.getElementById('call-audio-viz').classList.remove('hidden');
          document.getElementById('call-pulse-ring').classList.remove('hidden');
          callStartTime = Date.now();
          callTimerInterval = setInterval(updateCallTimer, 1000);
        },
        onDisconnect: () => {
          document.getElementById('call-status-dot').className = 'w-2.5 h-2.5 rounded-full bg-slate-300';
          document.getElementById('call-status-text').textContent = 'Call ended';
          document.getElementById('call-audio-viz').classList.add('hidden');
          document.getElementById('call-pulse-ring').classList.add('hidden');
          clearInterval(callTimerInterval);
          activeConversation = null;
          setTimeout(() => document.getElementById('call-overlay').classList.remove('active'), 1500);
        },
        onError: (error) => {
          console.error('Call error:', error);
          document.getElementById('call-status-dot').className = 'w-2.5 h-2.5 rounded-full bg-red-400';
          document.getElementById('call-status-text').textContent = 'Error';
          const errEl = document.getElementById('call-error');
          errEl.textContent = error.message || 'Connection failed';
          errEl.classList.remove('hidden');
          document.getElementById('call-audio-viz').classList.add('hidden');
        },
      });
    } catch(e) {
      console.error('Failed to start call:', e);
      document.getElementById('call-status-dot').className = 'w-2.5 h-2.5 rounded-full bg-red-400';
      document.getElementById('call-status-text').textContent = 'Failed to connect';
      const errEl = document.getElementById('call-error');
      errEl.textContent = e.message || 'Could not load voice SDK';
      errEl.classList.remove('hidden');
    }
  }

  function updateCallTimer() {
    if (!callStartTime) return;
    const secs = Math.floor((Date.now() - callStartTime) / 1000);
    document.getElementById('call-timer').textContent = Math.floor(secs/60) + ':' + String(secs%60).padStart(2,'0');
  }

  async function endCall() {
    clearInterval(callTimerInterval);
    if (activeConversation) {
      try { await activeConversation.endSession(); } catch(e) { /* ignore */ }
      activeConversation = null;
    }
    document.getElementById('call-overlay').classList.remove('active');
  }

  /* ── Archive ── */
  let expandedArchiveId = null;
  let archiveCountdownTimers = {}; // { "jobId_slug": intervalId }

  async function loadArchive() {
    const container = document.getElementById('archive-list');
    container.innerHTML = '<div class="flex justify-center py-8"><div class="w-6 h-6 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 0.8s linear infinite"></div></div>';
    try {
      const res = await fetch('/api/archive');
      const data = await res.json();
      const results = data.results || [];
      if (!results.length) {
        container.innerHTML = '<div class="flex flex-col items-center justify-center py-12 text-slate-400"><span class="material-icons text-4xl mb-2 opacity-40">science</span><p class="text-sm">No research yet</p></div>';
        return;
      }
      expandedArchiveId = null;
      // Store metadata in a lookup so we don't need to embed strings in onclick
      window._archiveMeta = {};
      container.innerHTML = results.map(r => {
        const date = r.completed_at ? new Date(r.completed_at).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
        const studies = r.num_studies ? r.num_studies + ' studies' : '';
        const docId = r.elevenlabs_doc_id || '';
        const stats = r.research_stats || {};
        const hh = stats.human_hours;
        const hoursText = hh && hh.total_hours > 0 ? `~${hh.total_hours}h equiv` : '';
        const jid = r.job_id || '';
        const nbUrls = r.notebooklm_urls || [];
        window._archiveMeta[jid] = { docId, resultUrl: r.result_url || '', query: r.query || '', nbUrls };
        return `<div id="archive-item-${esc(jid)}" class="archive-item glass-panel rounded-xl shadow-glass border border-white/60" data-jid="${escAttr(jid)}" data-docid="${escAttr(docId)}">
          <div class="flex items-center gap-3 p-4 pb-2">
            <div class="flex-1 min-w-0">
              <h3 class="font-semibold text-sm text-slate-700 line-clamp-2">${esc(r.query||'Untitled')}</h3>
              <div class="flex flex-wrap gap-2 text-[11px] text-slate-400 mt-1">
                <span class="bg-primary/10 text-primary px-2 py-0.5 rounded-md font-semibold">${esc(r.depth||'')}</span>
                ${studies ? '<span>'+studies+'</span>' : ''}
                ${hoursText ? '<span class="text-rose-400">'+hoursText+'</span>' : ''}
                ${date ? '<span>'+date+'</span>' : ''}
              </div>
            </div>
            <span class="material-icons archive-chevron text-slate-300 text-lg flex-shrink-0">expand_more</span>
          </div>
          <div id="archive-detail-${esc(jid)}" class="archive-detail">
            <div class="flex flex-wrap items-center gap-2 mb-3">
              ${r.result_url ? `<button data-action="view-report" data-url="${escAttr(r.result_url)}" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-semibold text-white bg-gradient-to-r from-primary to-cyan-400 hover:opacity-90 transition-opacity"><span class="material-icons text-sm">open_in_new</span>View Report</button>` : ''}
              ${r.result_url ? `<button data-action="copy-url" data-url="${escAttr(r.result_url)}" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-medium text-slate-500 border border-slate-200 hover:bg-slate-50 transition-colors"><span class="material-icons text-sm">content_copy</span>Copy URL</button>` : ''}
              <button data-action="amend" data-jid="${escAttr(jid)}" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-medium text-slate-500 border border-slate-200 hover:bg-amber-50 hover:text-amber-600 hover:border-amber-200 transition-colors"><span class="material-icons text-sm">edit</span>Amend</button>
              <button data-action="delete" data-jid="${escAttr(jid)}" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-medium text-slate-500 border border-slate-200 hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-colors ml-auto"><span class="material-icons text-sm">delete_forever</span>Delete</button>
            </div>
            ${nbUrls.length ? `
            <div class="text-[11px] font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-1">NotebookLM Sources</div>
            <div class="mb-3 space-y-1">
              <button data-action="copy-all-nb" data-jid="${escAttr(jid)}" class="flex items-center gap-1 text-[11px] text-primary font-medium hover:underline mb-1"><span class="material-icons" style="font-size:14px">content_copy</span>Copy all URLs</button>
              ${nbUrls.map((u, i) => `<div class="flex items-center gap-2 text-[11px]">
                <span class="text-slate-400 truncate flex-1" title="${escAttr(u.url)}">${esc(u.label)}</span>
                <button data-action="copy-nb-url" data-url="${escAttr(u.url)}" class="flex items-center gap-0.5 text-slate-400 hover:text-primary transition-colors flex-shrink-0"><span class="material-icons" style="font-size:13px">content_copy</span></button>
              </div>`).join('')}
            </div>
            ` : ''}
            <div class="text-[11px] font-semibold text-slate-400 uppercase tracking-wider mb-2">Agents</div>
            <div id="archive-agents-${esc(jid)}" class="space-y-2">
              <div class="flex justify-center py-3"><div class="w-4 h-4 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 0.8s linear infinite"></div></div>
            </div>
          </div>
        </div>`;
      }).join('');
      restoreArchiveCountdowns();
    } catch(e) {
      container.innerHTML = '<div class="flex flex-col items-center justify-center py-12 text-slate-400"><span class="material-icons text-4xl mb-2 opacity-40">cloud_off</span><p class="text-sm">Failed to load archive</p></div>';
    }
  }

  // Event delegation for archive list — handles all clicks
  document.addEventListener('click', function(event) {
    // Handle action buttons inside archive detail
    const actionBtn = event.target.closest('[data-action]');
    if (actionBtn && actionBtn.closest('#archive-list')) {
      event.stopPropagation();
      const action = actionBtn.dataset.action;
      if (action === 'view-report') {
        window.open(actionBtn.dataset.url, '_blank');
      } else if (action === 'copy-url') {
        navigator.clipboard.writeText(actionBtn.dataset.url);
        const icon = actionBtn.querySelector('.material-icons');
        icon.textContent = 'check';
        setTimeout(() => icon.textContent = 'content_copy', 1500);
      } else if (action === 'amend') {
        const jid = actionBtn.dataset.jid;
        const meta = (window._archiveMeta || {})[jid] || {};
        amendResearch(jid, (meta.query || '').substring(0, 120));
      } else if (action === 'delete') {
        deleteResearch(actionBtn.dataset.jid);
      } else if (action === 'copy-nb-url') {
        navigator.clipboard.writeText(actionBtn.dataset.url);
        const icon = actionBtn.querySelector('.material-icons');
        icon.textContent = 'check';
        setTimeout(() => icon.textContent = 'content_copy', 1500);
      } else if (action === 'copy-all-nb') {
        const jid = actionBtn.dataset.jid;
        const meta = (window._archiveMeta || {})[jid] || {};
        const allUrls = (meta.nbUrls || []).map(u => u.url).join('\n');
        navigator.clipboard.writeText(allUrls);
        const icon = actionBtn.querySelector('.material-icons');
        icon.textContent = 'check';
        setTimeout(() => icon.textContent = 'content_copy', 1500);
      }
      return;
    }

    // Handle archive item expand/collapse
    const archiveItem = event.target.closest('.archive-item');
    if (!archiveItem || !archiveItem.closest('#archive-list')) return;
    if (event.target.closest('button')) return;

    const jobId = archiveItem.dataset.jid;
    const docId = archiveItem.dataset.docid;
    if (!jobId) return;

    const detail = document.getElementById('archive-detail-' + jobId);
    if (!detail) return;

    const isExpanded = archiveItem.classList.contains('expanded');

    // Collapse any currently expanded item
    if (expandedArchiveId && expandedArchiveId !== jobId) {
      const prevItem = document.getElementById('archive-item-' + expandedArchiveId);
      const prevDetail = document.getElementById('archive-detail-' + expandedArchiveId);
      if (prevItem) prevItem.classList.remove('expanded');
      if (prevDetail) prevDetail.classList.remove('open');
    }

    if (isExpanded) {
      archiveItem.classList.remove('expanded');
      detail.classList.remove('open');
      expandedArchiveId = null;
    } else {
      archiveItem.classList.add('expanded');
      detail.classList.add('open');
      expandedArchiveId = jobId;
      loadArchiveAgents(jobId, docId);
    }
  });

  async function loadArchiveAgents(jobId, docId) {
    const container = document.getElementById('archive-agents-' + jobId);
    if (!container) return;
    container.innerHTML = '<div class="flex justify-center py-3"><div class="w-4 h-4 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 0.8s linear infinite"></div></div>';
    try {
      const res = await fetch('/api/agents?fresh=1');
      const data = await res.json();
      const agents = data.agents || [];
      agentsData = agents;

      if (!docId) {
        container.innerHTML = '<div class="flex items-center gap-2 text-[11px] text-amber-500 py-2"><span class="material-icons text-sm">info</span>No KB document uploaded for this research</div>';
        return;
      }

      container.innerHTML = agents.map(a => {
        const isAssigned = (a.kb_docs || []).some(d => d.id === docId);
        const kbCount = (a.kb_docs || []).length;
        const colorMap = { cyan: '#0dccf2', amber: '#f59e0b', violet: '#8b5cf6' };
        const countdownKey = 'ragCountdown_' + jobId + '_' + a.slug;
        const hasCountdown = localStorage.getItem(countdownKey);
        let countdownActive = false;
        if (hasCountdown) {
          try { countdownActive = JSON.parse(hasCountdown).endTime > Date.now(); } catch(e) {}
        }

        return `<div id="archive-agent-${jobId}-${a.slug}" class="archive-agent-row" onclick="event.stopPropagation()">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-white/80 shadow-inner-chrome flex items-center justify-center flex-shrink-0">
              <span class="material-icons text-lg" style="color:${colorMap[a.color]||'#0dccf2'}">${esc(a.icon)}</span>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="font-semibold text-slate-700 text-xs">${esc(a.name)}</span>
                ${isAssigned
                  ? '<span class="flex items-center gap-0.5 text-[10px] text-emerald-600 font-semibold"><span class="material-icons" style="font-size:12px">check_circle</span>Assigned</span>'
                  : '<span class="text-[10px] text-slate-400">Not assigned</span>'}
              </div>
              <div class="text-[10px] text-slate-400">KB: ${kbCount} doc${kbCount !== 1 ? 's' : ''}</div>
            </div>
            <div class="flex items-center gap-2">
              ${isAssigned ? `
                <button onclick="event.stopPropagation();App.archiveStartChat('${esc(a.agent_id)}','${esc(a.name)}','${jobId}','${esc(a.slug)}')"
                  id="archive-chat-btn-${jobId}-${a.slug}"
                  class="flex items-center gap-1 px-2.5 py-1 rounded-lg text-[11px] font-semibold text-white bg-gradient-to-r from-primary to-cyan-400 hover:opacity-90 transition-opacity ${countdownActive ? 'opacity-50 pointer-events-none' : ''}"
                  ${countdownActive ? 'disabled' : ''}>
                  <span class="material-icons" style="font-size:14px">chat</span>Chat
                </button>
                <button onclick="event.stopPropagation();App.archiveUnassign('${jobId}','${esc(a.slug)}','${esc(a.agent_id)}','${esc(docId)}')"
                  class="flex items-center gap-1 px-2.5 py-1 rounded-lg text-[11px] font-medium text-slate-500 border border-slate-200 hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-colors">
                  <span class="material-icons" style="font-size:14px">link_off</span>Unassign
                </button>
              ` : `
                <button onclick="event.stopPropagation();App.archiveAssign('${jobId}','${esc(a.slug)}','${esc(a.agent_id)}','${esc(docId)}')"
                  id="archive-assign-btn-${jobId}-${a.slug}"
                  class="flex items-center gap-1 px-2.5 py-1 rounded-lg text-[11px] font-semibold text-white bg-gradient-to-r from-primary to-cyan-400 hover:opacity-90 transition-opacity">
                  <span class="material-icons" style="font-size:14px">add_circle</span>Assign
                </button>
              `}
            </div>
          </div>
          <div id="archive-countdown-${jobId}-${a.slug}" class="${countdownActive ? 'archive-countdown mt-2 flex items-center gap-2 text-[11px] text-amber-600' : 'hidden'}">
            <span class="material-icons" style="font-size:14px">hourglass_top</span>
            RAG indexing — <span id="archive-timer-${jobId}-${a.slug}">5:00</span> remaining
          </div>
        </div>`;
      }).join('');

      // Restore any active countdowns for this job
      agents.forEach(a => {
        const countdownKey = 'ragCountdown_' + jobId + '_' + a.slug;
        const saved = localStorage.getItem(countdownKey);
        if (saved) {
          try {
            const { endTime } = JSON.parse(saved);
            if (endTime > Date.now()) {
              runArchiveCountdown(jobId, a.slug, endTime);
            } else {
              localStorage.removeItem(countdownKey);
            }
          } catch(e) { localStorage.removeItem(countdownKey); }
        }
      });
    } catch(e) {
      container.innerHTML = '<p class="text-xs text-red-400 text-center py-2">Failed to load agents</p>';
    }
  }

  async function archiveAssign(jobId, slug, agentId, docId) {
    const btn = document.getElementById('archive-assign-btn-' + jobId + '-' + slug);
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<div class="w-3 h-3 border-2 border-white/50 border-t-white rounded-full" style="animation:spin 0.8s linear infinite"></div> Assigning...';
    }
    try {
      const res = await fetch('/api/agents/' + slug + '/attach', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ doc_id: docId, doc_name: 'Research' })
      });
      const data = await res.json();
      if (res.ok) {
        // Start countdown
        const endTime = Date.now() + 5 * 60 * 1000;
        const countdownKey = 'ragCountdown_' + jobId + '_' + slug;
        localStorage.setItem(countdownKey, JSON.stringify({ endTime, agentId }));
        // Reload agent rows for this item
        loadArchiveAgents(jobId, docId);
      } else if (data.rag_not_ready) {
        // Show inline RAG indexing message — keep button disabled
        const row = document.getElementById('archive-agent-' + jobId + '-' + slug);
        if (row) {
          const cd = row.querySelector('[id^="archive-countdown-"]');
          if (cd) {
            cd.className = 'archive-countdown mt-2 flex items-center gap-2 text-[11px] text-amber-600';
            cd.innerHTML = '<span class="material-icons" style="font-size:14px">hourglass_top</span> Document still indexing at ElevenLabs. Try again in a few minutes.';
          }
        }
        if (btn) {
          btn.disabled = true;
          btn.classList.add('opacity-50');
          btn.innerHTML = '<span class="material-icons" style="font-size:14px">hourglass_top</span>Indexing...';
          // Re-enable after 60s so user can retry
          setTimeout(() => {
            btn.disabled = false;
            btn.classList.remove('opacity-50');
            btn.innerHTML = '<span class="material-icons" style="font-size:14px">add_circle</span>Retry';
          }, 60000);
        }
      } else {
        alert(data.error || 'Failed to assign');
        if (btn) { btn.disabled = false; btn.innerHTML = '<span class="material-icons" style="font-size:14px">add_circle</span>Assign'; }
      }
    } catch(e) {
      alert('Connection failed: ' + e.message);
      if (btn) { btn.disabled = false; btn.innerHTML = '<span class="material-icons" style="font-size:14px">add_circle</span>Assign'; }
    }
  }

  async function archiveUnassign(jobId, slug, agentId, docId) {
    if (!confirm('Unassign this research from ' + slug + '?')) return;
    try {
      const res = await fetch('/api/agents/' + slug + '/kb/' + docId, { method: 'DELETE' });
      if (res.ok) {
        // Clear any countdown for this agent
        const countdownKey = 'ragCountdown_' + jobId + '_' + slug;
        localStorage.removeItem(countdownKey);
        if (archiveCountdownTimers[countdownKey]) {
          clearInterval(archiveCountdownTimers[countdownKey]);
          delete archiveCountdownTimers[countdownKey];
        }
        // Reload agent rows
        loadArchiveAgents(jobId, docId);
      } else {
        const data = await res.json();
        alert(data.error || 'Failed to unassign');
      }
    } catch(e) {
      alert('Connection failed: ' + e.message);
    }
  }

  function archiveStartChat(agentId, agentName, jobId, slug) {
    // Check if countdown is active
    const countdownKey = 'ragCountdown_' + jobId + '_' + slug;
    const saved = localStorage.getItem(countdownKey);
    if (saved) {
      try {
        const { endTime } = JSON.parse(saved);
        if (endTime > Date.now()) {
          alert('RAG indexing is still in progress. Please wait for the countdown to finish.');
          return;
        }
      } catch(e) {}
    }
    startCall(agentId, agentName);
  }

  function runArchiveCountdown(jobId, slug, endTime) {
    const countdownKey = 'ragCountdown_' + jobId + '_' + slug;
    const countdownEl = document.getElementById('archive-countdown-' + jobId + '-' + slug);
    const timerEl = document.getElementById('archive-timer-' + jobId + '-' + slug);
    const chatBtn = document.getElementById('archive-chat-btn-' + jobId + '-' + slug);

    if (countdownEl) {
      countdownEl.className = 'archive-countdown mt-2 flex items-center gap-2 text-[11px] text-amber-600';
    }
    if (chatBtn) {
      chatBtn.classList.add('opacity-50', 'pointer-events-none');
      chatBtn.disabled = true;
    }

    // Clear any existing timer for this key
    if (archiveCountdownTimers[countdownKey]) {
      clearInterval(archiveCountdownTimers[countdownKey]);
    }

    archiveCountdownTimers[countdownKey] = setInterval(() => {
      const remaining = Math.max(0, endTime - Date.now());
      if (remaining <= 0) {
        clearInterval(archiveCountdownTimers[countdownKey]);
        delete archiveCountdownTimers[countdownKey];
        localStorage.removeItem(countdownKey);
        if (countdownEl) countdownEl.className = 'hidden';
        if (chatBtn) {
          chatBtn.classList.remove('opacity-50', 'pointer-events-none');
          chatBtn.disabled = false;
        }
        return;
      }
      const m = Math.floor(remaining / 60000);
      const s = Math.floor((remaining % 60000) / 1000);
      if (timerEl) timerEl.textContent = m + ':' + String(s).padStart(2, '0');
    }, 1000);
  }

  function restoreArchiveCountdowns() {
    // Scan localStorage for any active archive countdowns
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('ragCountdown_')) {
        try {
          const { endTime } = JSON.parse(localStorage.getItem(key));
          if (endTime <= Date.now()) {
            localStorage.removeItem(key);
          }
          // Countdown will be restored when the item is expanded and agents are loaded
        } catch(e) { localStorage.removeItem(key); }
      }
    }
  }

  let amendJobId = '';

  function amendResearch(jobId, query) {
    amendJobId = jobId;
    document.getElementById('amend-original-query').textContent = query;
    document.getElementById('amend-questions').value = '';
    document.getElementById('amend-perspective').value = '';
    showView('amend');
  }

  async function submitAmendment() {
    const questions = document.getElementById('amend-questions').value.trim();
    const perspective = document.getElementById('amend-perspective').value.trim();
    if (!questions) { alert('Please enter at least one question.'); return; }

    const btn = document.getElementById('amend-submit-btn');
    btn.disabled = true;
    btn.textContent = 'Starting...';

    try {
      const res = await fetch('/api/research/amend', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          job_id: amendJobId,
          additional_questions: questions,
          perspective: perspective,
        })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Request failed');

      const jobId = data.job_id;
      const now = Date.now();
      activeJobs[jobId] = {
        query: 'Amendment: ' + (document.getElementById('amend-original-query').textContent || '').substring(0, 80),
        depth: 'STANDARD',
        startTime: now,
        estimatedSeconds: data.estimated_seconds || 300,
        phase: 'Starting...', status: 'running',
        phaseTimings: {}, researchStats: {}, studyProgress: [], currentStep: '',
      };
      viewingJobId = jobId;
      persistActiveJobs();
      resetProgressView(now, data.estimated_seconds || 300);
      ensurePolling();
      showView('progress');
    } catch(e) {
      alert('Failed to start amendment: ' + e.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'Run Amendment';
    }
  }

  async function deleteResearch(jobId) {
    if (!confirm('Delete this research? This will remove it from the archive and all agents.')) return;
    try {
      const res = await fetch('/api/archive/' + jobId, { method: 'DELETE' });
      if (res.ok) {
        loadArchive(); // Refresh archive list
      } else {
        const data = await res.json();
        alert(data.error || 'Failed to delete');
      }
    } catch(e) {
      alert('Failed to delete: ' + e.message);
    }
  }

  // archiveChat removed — chat now starts directly from archive expand view via archiveStartChat

  function copyReportUrl() {
    const link = document.getElementById('result-link');
    const url = link ? link.href : '';
    if (!url || url === '#' || url.endsWith('#')) return;
    navigator.clipboard.writeText(url).then(() => {
      const btn = document.getElementById('copy-url-btn');
      const icon = btn.querySelector('.material-icons');
      icon.textContent = 'check';
      btn.classList.add('text-emerald-500', 'border-emerald-300');
      setTimeout(() => { icon.textContent = 'content_copy'; btn.classList.remove('text-emerald-500', 'border-emerald-300'); }, 2000);
    }).catch(() => prompt('Copy this URL:', url));
  }

  function renderNotebookLmSources(urls) {
    const section = document.getElementById('notebooklm-section');
    const list = document.getElementById('notebooklm-list');
    if (!urls || !urls.length) { section.classList.add('hidden'); return; }
    section.classList.remove('hidden');
    list.classList.add('hidden'); // start collapsed
    list.innerHTML = urls.map(s => `
      <div class="flex items-center gap-2 py-1.5 px-3 rounded-lg bg-white/50 border border-white/60">
        <span class="material-icons text-sm text-primary/60">description</span>
        <span class="flex-1 text-[11px] text-slate-600 truncate">${esc(s.label)}</span>
        <button onclick="navigator.clipboard.writeText('${esc(s.url)}');this.querySelector('.material-icons').textContent='check';setTimeout(()=>this.querySelector('.material-icons').textContent='content_copy',1500)"
                class="flex items-center gap-0.5 text-[10px] text-slate-400 hover:text-primary transition-colors" title="Copy URL">
          <span class="material-icons text-xs">content_copy</span>
        </button>
      </div>
    `).join('') + `
      <button onclick="copyAllNotebookLmUrls()" class="w-full mt-1 py-2 rounded-lg border border-dashed border-slate-200 text-[11px] text-slate-400 hover:text-primary hover:border-primary transition-colors flex items-center justify-center gap-1">
        <span class="material-icons text-sm">copy_all</span> Copy all URLs
      </button>`;
  }

  function copyAllNotebookLmUrls() {
    const items = document.querySelectorAll('#notebooklm-list .truncate');
    const section = document.getElementById('notebooklm-section');
    // Collect URLs from the copy buttons' onclick handlers
    const urls = [];
    document.querySelectorAll('#notebooklm-list button[title="Copy URL"]').forEach(btn => {
      const match = btn.getAttribute('onclick').match(/writeText\('([^']+)'\)/);
      if (match) urls.push(match[1]);
    });
    if (!urls.length) return;
    navigator.clipboard.writeText(urls.join('\n')).then(() => {
      const copyBtn = document.querySelector('#notebooklm-list button:last-child');
      if (copyBtn) { copyBtn.innerHTML = '<span class="material-icons text-sm text-emerald-500">check</span> Copied!'; setTimeout(() => { copyBtn.innerHTML = '<span class="material-icons text-sm">copy_all</span> Copy all URLs'; }, 2000); }
    });
  }

  /* ── Watches ── */
  async function loadWatches() {
    const list = document.getElementById('watches-list');
    list.innerHTML = '<div class="flex justify-center py-8"><div class="w-6 h-6 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 0.8s linear infinite"></div></div>';
    try {
      const res = await fetch('/api/watches');
      const data = await res.json();
      const watches = data.watches || [];
      if (!watches.length) {
        list.innerHTML = '<div class="flex flex-col items-center justify-center py-12 text-slate-400"><span class="material-icons text-4xl mb-2 opacity-40">visibility</span><p class="text-sm">No watches yet</p></div>';
        return;
      }
      list.innerHTML = watches.map(w => {
        const lastChecked = w.last_checked ? new Date(w.last_checked).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : 'Never';
        const lastChanged = w.last_changed ? new Date(w.last_changed).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
        const intervalLabel = w.interval_hours <= 6 ? 'Every 6h' : w.interval_hours <= 12 ? 'Every 12h' : w.interval_hours <= 24 ? 'Daily' : 'Weekly';
        return `<div class="glass-panel rounded-xl p-3 shadow-glass border border-white/60">
          <div class="flex items-start gap-2">
            <span class="material-icons text-primary text-lg mt-0.5">visibility</span>
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium text-slate-700 truncate">${esc(w.query)}</div>
              <div class="flex flex-wrap gap-2 text-[10px] text-slate-400 mt-1">
                <span class="bg-primary/10 text-primary px-1.5 py-0.5 rounded">${intervalLabel}</span>
                <span>Last: ${lastChecked}</span>
                ${lastChanged ? `<span class="text-amber-500">Changed: ${lastChanged}</span>` : ''}
                <span>${w.history_count} checks</span>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2 mt-2 ml-7">
            <button onclick="App.checkWatch('${esc(w.id)}')" class="text-[11px] text-primary font-medium flex items-center gap-1 hover:underline"><span class="material-icons text-sm">refresh</span>Check now</button>
            <button onclick="App.deleteWatch('${esc(w.id)}')" class="text-[11px] text-slate-400 font-medium flex items-center gap-1 hover:text-red-500 transition-colors ml-auto"><span class="material-icons text-sm">delete</span></button>
          </div>
        </div>`;
      }).join('');
    } catch(e) {
      list.innerHTML = '<p class="text-sm text-red-400 text-center py-8">Failed to load watches</p>';
    }
  }

  async function createWatch() {
    const query = document.getElementById('watch-query').value.trim();
    const interval = document.getElementById('watch-interval').value;
    if (!query) { alert('Please enter a topic to monitor.'); return; }
    const payload = { query, interval_hours: parseInt(interval) };
    const email = document.getElementById('watch-email').value.trim();
    const webhook = document.getElementById('watch-webhook').value.trim();
    if (email) payload.notification_email = email;
    if (webhook) payload.notification_webhook = webhook;
    try {
      const res = await fetch('/api/watches', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        document.getElementById('watch-query').value = '';
        document.getElementById('watch-email').value = '';
        document.getElementById('watch-webhook').value = '';
        loadWatches();
      } else {
        const data = await res.json();
        alert(data.error || 'Failed to create watch');
      }
    } catch(e) {
      alert('Failed: ' + e.message);
    }
  }

  async function checkWatch(watchId) {
    try {
      const res = await fetch('/api/watches/' + watchId + '/check', { method: 'POST' });
      const data = await res.json();
      if (res.ok) {
        const msg = data.changed ? 'Changes detected!\n\n' + data.summary : 'No significant changes detected.';
        alert(msg);
        loadWatches();
      } else {
        alert(data.error || 'Check failed');
      }
    } catch(e) {
      alert('Check failed: ' + e.message);
    }
  }

  async function deleteWatch(watchId) {
    if (!confirm('Delete this watch?')) return;
    try {
      const res = await fetch('/api/watches/' + watchId, { method: 'DELETE' });
      if (res.ok) loadWatches();
    } catch(e) { alert('Failed: ' + e.message); }
  }

  /* ── Knowledge Graph ── */
  let graphData = null;

  async function loadGraph() {
    const list = document.getElementById('graph-entities-list');
    list.innerHTML = '<div class="flex justify-center py-8"><div class="w-6 h-6 border-2 border-slate-200 border-t-primary rounded-full" style="animation:spin 0.8s linear infinite"></div></div>';
    try {
      const res = await fetch('/api/graph');
      graphData = await res.json();
      document.getElementById('graph-entities-count').textContent = graphData.stats?.total_entities || 0;
      document.getElementById('graph-rels-count').textContent = graphData.stats?.total_relationships || 0;
      renderGraphEntities(graphData.entities || []);
    } catch(e) {
      list.innerHTML = '<p class="text-sm text-red-400 text-center py-8">Failed to load graph</p>';
    }
  }

  function renderGraphEntities(entities) {
    const list = document.getElementById('graph-entities-list');
    if (!entities.length) {
      list.innerHTML = '<div class="flex flex-col items-center justify-center py-12 text-slate-400"><span class="material-icons text-4xl mb-2 opacity-40">hub</span><p class="text-sm">No entities yet — complete some research first</p></div>';
      return;
    }
    const typeColors = {company:'primary',person:'amber-500',product:'emerald-500',concept:'violet-500',technology:'cyan-500',regulation:'rose-500',market:'indigo-500'};
    list.innerHTML = entities.map(e => {
      const color = typeColors[e.type] || 'slate-400';
      const rels = (graphData?.relationships || []).filter(r => r.from === e.name || r.to === e.name);
      const relText = rels.slice(0,3).map(r => {
        const other = r.from === e.name ? r.to : r.from;
        return `<span class="text-[10px] text-slate-400">${esc(r.type.replace('_',' '))} → ${esc(other)}</span>`;
      }).join(', ');
      return `<div class="glass-panel rounded-lg p-3 shadow-glass border border-white/60">
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-${color}"></span>
          <span class="text-sm font-medium text-slate-700">${esc(e.name)}</span>
          <span class="text-[10px] bg-${color}/10 text-${color} px-1.5 py-0.5 rounded font-medium">${esc(e.type)}</span>
          <span class="text-[10px] text-slate-400 ml-auto">${e.mentions} mention${e.mentions !== 1 ? 's' : ''}</span>
        </div>
        ${relText ? `<div class="ml-4 mt-1 flex flex-wrap gap-1">${relText}</div>` : ''}
      </div>`;
    }).join('');
  }

  function filterGraph(query) {
    if (!graphData) return;
    const q = query.toLowerCase();
    const filtered = (graphData.entities || []).filter(e =>
      e.name.toLowerCase().includes(q) ||
      e.type.toLowerCase().includes(q) ||
      (e.aliases || []).some(a => a.toLowerCase().includes(q))
    );
    renderGraphEntities(filtered);
  }

  /* ── Stats ── */
  async function loadStats() {
    try {
      const res = await fetch('/api/stats');
      const data = await res.json();
      document.getElementById('stat-researching').textContent = String(data.researching||0).padStart(2,'0');
      document.getElementById('stat-completed').textContent = data.completed || 0;
    } catch(e) { /* silent */ }
    try {
      const res = await fetch('/api/agents');
      const data = await res.json();
      for (const a of (data.agents || [])) {
        const el = document.getElementById('kb-' + a.slug);
        if (el) el.textContent = String(a.kb_count).padStart(2, '0');
      }
    } catch(e) { /* silent */ }
  }

  function retry() { queryInput.value = lastQuery; showView('home'); }

  function resumeProgress() {
    if (viewingJobId && activeJobs[viewingJobId]) showView('progress');
  }

  /* ── Init ── */
  loadStats();
  setInterval(loadStats, 30000);

  // Restore active jobs from localStorage
  (async function restoreActiveJobs() {
    const saved = localStorage.getItem('activeJobs');
    if (!saved) {
      // Migrate from old single-job format
      const oldSaved = localStorage.getItem('activeJob');
      if (oldSaved) {
        try {
          const old = JSON.parse(oldSaved);
          if (old.jobId) {
            const res = await fetch('/api/status/' + old.jobId);
            if (res.ok) {
              const data = await res.json();
              if (data.status === 'running') {
                activeJobs[old.jobId] = {
                  query: old.query || '', depth: old.depth || 'STANDARD',
                  startTime: old.startTime || Date.now(), estimatedSeconds: old.estimatedSeconds || 300,
                  phase: data.phase || '', status: 'running', phaseTimings: data.phase_timings || {},
                  researchStats: data.research_stats || {}, studyProgress: data.study_progress || [],
                  currentStep: data.current_step || '',
                };
                viewingJobId = old.jobId;
              }
            }
          }
        } catch(e) {}
        localStorage.removeItem('activeJob');
      }
      if (!hasActiveJobs()) return;
      persistActiveJobs();
      renderBanners();
      ensurePolling();
      return;
    }

    try {
      const jobs = JSON.parse(saved);
      for (const [jid, j] of Object.entries(jobs)) {
        try {
          const res = await fetch('/api/status/' + jid);
          if (!res.ok) continue;
          const data = await res.json();
          if (data.status === 'running') {
            activeJobs[jid] = {
              query: j.query || '', depth: j.depth || 'STANDARD',
              startTime: j.startTime || Date.now(), estimatedSeconds: j.estimatedSeconds || 300,
              phase: data.phase || '', status: 'running', phaseTimings: data.phase_timings || {},
              researchStats: data.research_stats || {}, studyProgress: data.study_progress || [],
              currentStep: data.current_step || '',
            };
            if (!viewingJobId) viewingJobId = jid;
          }
        } catch(e) {}
      }
      persistActiveJobs(); // Clean up completed jobs
      if (hasActiveJobs()) {
        renderBanners();
        ensurePolling();
      }
    } catch(e) {
      localStorage.removeItem('activeJobs');
    }
  })();

  /* ── Init reassign countdown ── */
  restoreReassignCountdown();

  /* ── Public API ── */
  return { showView, retry, assignToAgent, startCall, endCall, copyReportUrl, useSuggested, forceStart, resumeProgress, viewJob, toggleReassign, deleteResearch, amendResearch, submitAmendment, filterGraph, createWatch, checkWatch, deleteWatch, archiveAssign, archiveUnassign, archiveStartChat };
})();
</script>
</body>
</html>
